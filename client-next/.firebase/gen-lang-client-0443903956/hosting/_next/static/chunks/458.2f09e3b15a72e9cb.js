"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[458],{458:(e,r,t)=>{t.r(r),t.d(r,{default:()=>em,dynamic:()=>ep});var o=t(5155),n=t(2115),a=t(7024),i=t(6520),s=t(5125),l=t(63),c=t(1408),d=t(2451),g=t(51),u=t(7621),p=t(550);async function f(){let e=localStorage.getItem("jwt");if(e)return{Authorization:"Bearer ".concat(e)};try{let e=await (0,p.p9)();if(e)return localStorage.setItem("jwt",e),{Authorization:"Bearer ".concat(e)}}catch(e){console.error("Failed to get Firebase token:",e)}return{}}function m(e){var r,t,i,l;let{isOpen:p,onClose:m,onStartConversation:h,currentLanguage:y}=e,[S,x]=(0,n.useState)(null),[b,v]=(0,n.useState)(!1),[T,w]=(0,n.useState)(""),[E,A]=(0,n.useState)(""),[k,C]=(0,n.useState)(!1),[I,D]=(0,n.useState)(!1),[R,j]=(0,n.useState)(""),[_,N]=(0,n.useState)(""),[O,P]=(0,n.useState)("friendly"),[F,B]=(0,n.useState)(""),[z,U]=(0,n.useState)([]),[M,L]=(0,n.useState)(!1),[G,W]=(0,n.useState)([]),[H,V]=(0,n.useState)(!1),[q,K]=(0,n.useState)(!1),[Y,J]=(0,n.useState)(""),[X,$]=(0,n.useState)(!1),[Q,Z]=(0,n.useState)(!1),[ee,er]=(0,n.useState)(!1),[et,eo]=(0,n.useState)(!1),[en,ea]=(0,n.useState)(null),[ei,es]=(0,n.useState)(null),{user:el}=(0,a.J)();(0,n.useCallback)(()=>{ei&&setTimeout(()=>{ei.scrollTo({top:ei.scrollHeight,behavior:"smooth"})},200)},[ei]);let ec=(0,n.useCallback)(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:200;ei&&setTimeout(()=>{ei.scrollTo({top:ei.scrollHeight,behavior:"smooth"})},e)},[ei]),ed=(0,n.useCallback)(async()=>{if(null==el?void 0:el.id)try{console.log("[TOPIC_MODAL] Fetching dashboards for user:",el.id),console.log("[TOPIC_MODAL] Current language:",y);let{success:e,data:r}=await (0,u.p5)(el.id);if(!e){console.error("Failed to fetch language dashboards"),v(!1);return}console.log("[TOPIC_MODAL] Available dashboards:",r);let t=(r||[]).find(e=>e.language===y);!t&&r&&r.length>0&&(t=r[0],console.log("[TOPIC_MODAL] No exact match found, using first available dashboard:",t)),t?(console.log("[TOPIC_MODAL] Using dashboard:",t),x(t),v(!0)):(console.log("[TOPIC_MODAL] No dashboard found"),v(!1))}catch(e){console.error("Error fetching language dashboard:",e),v(!1)}},[y,null==el?void 0:el.id]),eg=(0,n.useCallback)(async()=>{if(null==el?void 0:el.id){V(!0);try{let{success:e,data:r}=await (0,u.d8)(el.id);e?W(r||[]):(console.error("Failed to fetch personas"),W([]))}catch(e){console.error("Error fetching saved personas:",e),W([])}finally{V(!1)}}},[null==el?void 0:el.id]);(0,n.useEffect)(()=>{y&&p&&(ed(),eg())},[y,p,ed,eg]),(0,n.useEffect)(()=>{T||k&&R.trim()?($(!0),ec(300)):($(!1),A(""),N(""),D(!1))},[T,k,R,ec]),(0,n.useEffect)(()=>{let e=T||k&&R.trim(),r=_.trim()||E;e&&r?(Z(!0),ec(300)):(Z(!1),P("friendly"))},[T,k,R,_,E,ec]),(0,n.useEffect)(()=>{let e=T||k&&R.trim(),r=_.trim()||E;e&&r&&O?(er(!0),ec(300)):(er(!1),B(""))},[T,k,R,_,E,O,ec]),(0,n.useEffect)(()=>{(_.trim()||E)&&F&&ec(300)},[_,E,F,ec]),(0,n.useEffect)(()=>{F||(L(!1),U([]))},[F]),(0,n.useEffect)(()=>{k&&ec(400)},[k,ec]),(0,n.useEffect)(()=>{I&&ec(400)},[I,ec]);let eu=async()=>{if(console.log("[TOPIC_MODAL] Start practice button pressed"),!b)return void J("No language dashboard found. Complete onboarding or add this language.");let e=_.trim()||E;if(!e)return void J("Please select at least one scenario or enter a custom scenario.");if(!F)return void J("Please select a learning goal.");K(!0),J("");try{let o=await f();if(!o.Authorization){J("Authentication token missing. Please log in again."),K(!1);return}let n=(null==S?void 0:S.language)||y||"en",a=new AbortController,i=setTimeout(()=>a.abort(),7e4);try{console.log("[TOPIC_MODAL] Creating conversation with persona info:",{isUsingExistingPersona:et,selectedPersonaId:en,usesPersona:et,personaId:et?en:null});let r=await s.A.post("/api/conversations",{language:n,title:et?"".concat(e," Discussion (Persona)"):"".concat(e," Discussion"),topics:[e],formality:O,learningGoals:[F],selectedSubgoals:z.length>0?z:void 0,description:e,usesPersona:et,personaId:et?en:null},{headers:o,signal:a.signal});clearTimeout(i);let{conversation:t,aiMessage:l}=r.data;if(!(null==t?void 0:t.id)){J("Failed to create conversation. Check your language dashboard."),K(!1);return}console.log("[TOPIC_MODAL] Skipping verification - conversation ".concat(t.id," was created successfully")),console.log("[TOPIC_MODAL] Proceeding directly to analyze page"),h(t.id,[e],l,O,[F],e,et,z.length>0?z:void 0),m()}catch(i){var r,t;let e=null==i||null==(r=i.response)?void 0:r.status,o=null==i||null==(t=i.response)?void 0:t.data,n=null==o?void 0:o.code,a=(null==o?void 0:o.error)||(null==o?void 0:o.message);if(console.error("[TOPIC_MODAL] Create conversation failed:",{status:e,serverCode:n,serverMsg:a,data:o}),s.A.isCancel(i))J("Starting took too long. Please try again.");else if(a||n){let e=n?"".concat(n,": ").concat(a||"Unknown error"):a||"Unknown error";J("Failed to start conversation — ".concat(e))}else J("Failed to start conversation. Try again.");K(!1)}}catch(e){J("Failed to start conversation. Try again.")}};return p?(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("style",{children:"\n        /* Custom scrollbar styles */\n        .custom-scrollbar::-webkit-scrollbar {\n          width: 8px;\n        }\n        \n        .custom-scrollbar::-webkit-scrollbar-track {\n          background: transparent;\n          border-radius: 4px;\n        }\n        \n        .custom-scrollbar::-webkit-scrollbar-thumb {\n          background: var(--rose-accent);\n          border-radius: 4px;\n          transition: background-color 0.3s ease;\n        }\n        \n        .custom-scrollbar::-webkit-scrollbar-thumb:hover {\n          background: var(--rose-primary);\n        }\n        \n        .custom-scrollbar::-webkit-scrollbar-corner {\n          background: transparent;\n        }\n        \n        /* Firefox scrollbar */\n        .custom-scrollbar {\n          scrollbar-width: thin;\n          scrollbar-color: var(--rose-accent) transparent;\n        }\n        \n        /* Dark mode adjustments */\n        .dark .custom-scrollbar::-webkit-scrollbar-thumb {\n          background: var(--rose-accent);\n        }\n        \n        .dark .custom-scrollbar::-webkit-scrollbar-thumb:hover {\n          background: var(--rose-primary);\n        }\n      "}),(0,o.jsx)(c.N,{children:(0,o.jsx)(d.P.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0, 0, 0, 0.6)",backdropFilter:"blur(8px)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:9999,padding:"1rem"},onClick:m,children:(0,o.jsxs)(d.P.div,{initial:{opacity:0,scale:.9,y:-20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.9,y:-20},transition:{duration:.3,ease:[.4,0,.2,1]},layout:!0,style:{position:"relative",background:"var(--card)",border:"1px solid var(--border)",borderRadius:20,padding:"2rem",width:"700px",maxWidth:"90vw",maxHeight:"90vh",overflowY:"auto",boxSizing:"border-box",boxShadow:"0 25px 50px -12px rgba(0, 0, 0, 0.25)",transition:"all 0.4s cubic-bezier(0.4, 0, 0.2, 1)",scrollbarWidth:"thin",scrollbarColor:"var(--rose-accent) transparent"},className:"custom-scrollbar",onClick:e=>e.stopPropagation(),ref:es,children:[(0,o.jsx)("button",{onClick:m,style:{position:"absolute",top:"1rem",right:"1rem",background:"none",border:"none",fontSize:"1.5rem",cursor:"pointer",color:"var(--muted-foreground)",width:"32px",height:"32px",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",transition:"all 0.2s ease",zIndex:10},onMouseEnter:e=>{e.currentTarget.style.backgroundColor="var(--muted)",e.currentTarget.style.color="var(--foreground)"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="transparent",e.currentTarget.style.color="var(--muted-foreground)"},children:"\xd7"}),(0,o.jsxs)("div",{style:{textAlign:"center",marginBottom:"1.5rem"},children:[(0,o.jsx)("h2",{style:{color:"var(--foreground)",fontSize:"1.5rem",fontWeight:700,marginBottom:"0.5rem",fontFamily:"Gabriela, Arial, sans-serif"},children:"Start a Practice Session"}),(0,o.jsx)("p",{style:{color:"var(--muted-foreground)",fontSize:"0.9rem",lineHeight:1.5,fontFamily:"AR One Sans, Arial, sans-serif"},children:"Choose your topic, scenario, and conversation style"})]}),(0,o.jsx)(c.N,{children:G.length>0&&(0,o.jsxs)(d.P.div,{initial:{opacity:0,y:20,height:0},animate:{opacity:1,y:0,height:"auto"},exit:{opacity:0,y:-20,height:0},transition:{duration:.4,ease:[.4,0,.2,1]},layout:!0,style:{marginBottom:"1.5rem",overflow:"hidden"},children:[(0,o.jsx)("h3",{style:{color:"var(--foreground)",fontSize:"1rem",fontWeight:600,marginBottom:"0.75rem",fontFamily:"Montserrat, Arial, sans-serif",textAlign:"center",display:"flex",alignItems:"center",justifyContent:"center",gap:"0.5rem"},children:"\uD83C\uDFAD Your Saved Personas"}),(0,o.jsx)("div",{style:{display:"flex",gap:"1rem",overflowX:"auto",padding:"0.75rem",maxHeight:"120px",scrollbarWidth:"thin",scrollbarColor:"var(--rose-accent) transparent"},children:G.map(e=>(0,o.jsxs)(d.P.div,{whileHover:{y:-2,scale:1.02},whileTap:{scale:.98},onClick:()=>(e=>{if(e.topics&&e.topics.length>0&&(A(e.topics[0]),N(""),D(!1),$(!0)),e.formality&&(P(e.formality),Z(!0)),e.topics&&e.topics.length>0){let r=e.topics[0],t=g.O_.find(e=>{var t;return null==(t=e.subtopics)?void 0:t.some(e=>e.toLowerCase().includes(r.toLowerCase())||r.toLowerCase().includes(e.toLowerCase()))});t?(w(t.id),C(!1),j("")):(C(!0),j(r),w(""))}eo(!0),ea(e.id),J(""),er(!0)})(e),style:{minWidth:"100px",maxWidth:"100px",background:en===e.id?"rgba(126, 90, 117, 0.08)":"rgba(126,90,117,0.05)",borderRadius:12,padding:"0.75rem",border:"2px solid ".concat(en===e.id?"var(--rose-primary)":"rgba(126,90,117,0.1)"),transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",cursor:"pointer",position:"relative",boxShadow:en===e.id?"0 6px 20px rgba(126,90,117,0.2)":"0 3px 10px rgba(0, 0, 0, 0.12)",margin:"0 0.15rem"},children:[(0,o.jsx)("div",{style:{width:"32px",height:"32px",borderRadius:"50%",background:en===e.id?"linear-gradient(135deg, var(--rose-primary) 0%, #8a6a7a 100%)":"linear-gradient(135deg, rgba(126,90,117,0.8) 0%, rgba(138,106,122,0.8) 100%)",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 0.5rem auto",fontSize:"0.9rem",color:"#fff",fontWeight:"bold",fontFamily:"Montserrat, Arial, sans-serif",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)"},children:e.name.charAt(0).toUpperCase()}),(0,o.jsx)("div",{style:{textAlign:"center",fontWeight:600,color:en===e.id?"var(--rose-primary)":"var(--foreground)",fontSize:"0.75rem",marginBottom:"0.25rem",fontFamily:"Montserrat, Arial, sans-serif",transition:"color 0.3s ease",lineHeight:1.2},children:e.name}),(0,o.jsx)("div",{style:{fontSize:"0.6rem",color:"var(--muted-foreground)",lineHeight:1.2,fontFamily:"AR One Sans, Arial, sans-serif",textAlign:"center",overflow:"hidden",display:"-webkit-box",WebkitLineClamp:1,WebkitBoxOrient:"vertical"},children:e.description||"No description"})]},e.id))})]},"saved-personas")}),(0,o.jsx)(c.N,{children:Y&&(0,o.jsx)(d.P.div,{initial:{opacity:0,y:10,height:0},animate:{opacity:1,y:0,height:"auto"},exit:{opacity:0,y:-10,height:0},transition:{duration:.3,ease:[.4,0,.2,1]},layout:!0,style:{background:"rgba(220,53,69,0.1)",color:"#dc3545",padding:"0.75rem",borderRadius:12,marginBottom:"1.5rem",border:"1px solid rgba(220,53,69,0.2)",textAlign:"center",fontSize:"0.85rem",fontFamily:"AR One Sans, Arial, sans-serif",overflow:"hidden"},children:Y},"error-message")}),(0,o.jsx)(c.N,{children:!b&&(0,o.jsxs)(d.P.div,{initial:{opacity:0,y:10,height:0},animate:{opacity:1,y:0,height:"auto"},exit:{opacity:0,y:-10,height:0},transition:{duration:.3,ease:[.4,0,.2,1]},layout:!0,style:{background:"rgba(255, 215, 0, 0.15)",color:"#b8860b",padding:"1rem",borderRadius:12,marginBottom:"1.5rem",border:"1px solid #ffe066",textAlign:"center",fontWeight:600,fontSize:"0.85rem",fontFamily:"AR One Sans, Arial, sans-serif",overflow:"hidden"},children:["No language dashboard found.",(0,o.jsx)("br",{}),"Complete onboarding or add this language in dashboard settings."]},"dashboard-warning")}),(0,o.jsxs)(d.P.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.4,ease:[.4,0,.2,1]},layout:!0,style:{marginBottom:"2rem"},children:[(0,o.jsx)("h3",{style:{color:"var(--foreground)",fontSize:"1.1rem",fontWeight:600,marginBottom:"0.5rem",fontFamily:"Montserrat, Arial, sans-serif",display:"flex",alignItems:"center",gap:"0.5rem"},children:"\uD83D\uDCDA Choose Your Topic"}),(0,o.jsx)("p",{style:{color:"var(--muted-foreground)",fontSize:"0.85rem",marginBottom:"1rem",lineHeight:1.4,fontFamily:"AR One Sans, Arial, sans-serif"},children:"Select one topic for this practice session"}),(null==S?void 0:S.talk_topics)&&S.talk_topics.length>0&&(0,o.jsx)("div",{style:{marginBottom:"1rem"},children:(0,o.jsx)("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:"0.75rem"},children:S.talk_topics.map(e=>{let r=g.O_.find(r=>r.id===e);return r?(0,o.jsxs)(d.P.div,{whileHover:{y:-2,scale:1.02},whileTap:{scale:.98},onClick:()=>{w(r.id),j(""),C(!1),A(""),N(""),D(!1),eo(!1),ea(null),J("")},style:{padding:"0.75rem",borderRadius:12,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:"0.75rem",fontWeight:500,color:"var(--foreground)",fontSize:"0.85rem",minHeight:"50px",fontFamily:"Montserrat, Arial, sans-serif",border:"2px solid ".concat(T===r.id?"var(--rose-primary)":"transparent"),background:T===r.id?"rgba(126, 90, 117, 0.05)":"var(--card)",boxShadow:T===r.id?"0 4px 16px rgba(126, 90, 117, 0.15)":"0 4px 12px rgba(0, 0, 0, 0.15)",transition:"all 0.2s ease"},children:[(0,o.jsx)("span",{style:{fontSize:"1.1rem"},children:r.icon}),(0,o.jsx)("span",{children:r.label})]},r.id):null})})}),(0,o.jsx)("div",{style:{marginBottom:"1rem"},children:(0,o.jsxs)(d.P.div,{style:{display:"inline-flex",alignItems:"center",borderRadius:12,border:"2px solid ".concat(k?"var(--rose-primary)":"transparent"),background:k?"rgba(126, 90, 117, 0.05)":"var(--card)",boxShadow:k?"0 4px 16px rgba(126, 90, 117, 0.15)":"0 2px 8px rgba(0, 0, 0, 0.05)",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",overflow:"hidden"},children:[(0,o.jsxs)(d.P.button,{whileHover:{scale:1.02},whileTap:{scale:.98},onClick:()=>{k?(C(!1),j(""),N(""),D(!1)):(C(!0),w("")),A(""),eo(!1),ea(null),J("")},style:{padding:"0.6rem 0.8rem",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:"0.6rem",fontWeight:500,color:"var(--foreground)",fontSize:"0.85rem",fontFamily:"Montserrat, Arial, sans-serif",background:"transparent",border:"none",whiteSpace:"nowrap",transition:"all 0.2s ease"},children:[(0,o.jsx)("span",{style:{fontSize:"1.1rem"},children:"✍️"})," Use Custom Topic"]}),(0,o.jsx)(c.N,{children:k&&(0,o.jsx)(d.P.div,{initial:{width:0,opacity:0},animate:{width:"auto",opacity:1},exit:{width:0,opacity:0},transition:{duration:.3,ease:[.4,0,.2,1]},style:{overflow:"hidden"},children:(0,o.jsx)("input",{type:"text",placeholder:"Enter your custom topic...",value:R,onChange:e=>j(e.target.value),style:{padding:"0.6rem 0.8rem",border:"none",fontSize:"0.85rem",fontFamily:"inherit",background:"transparent",color:"var(--foreground)",outline:"none",minWidth:"200px",width:"100%"},autoFocus:!0})})})]})}),!k&&(!(null==S?void 0:S.talk_topics)||0===S.talk_topics.length)&&(0,o.jsx)("div",{style:{padding:"1.5rem",background:"rgba(126,90,117,0.05)",borderRadius:12,textAlign:"center",color:"var(--muted-foreground)",fontSize:"0.85rem",fontFamily:"AR One Sans, Arial, sans-serif",border:"1px solid var(--border)"},children:"No topics available. Add topics in dashboard settings."})]}),(0,o.jsx)(c.N,{children:X&&(0,o.jsxs)(d.P.div,{initial:{opacity:0,y:20,height:0},animate:{opacity:1,y:0,height:"auto"},exit:{opacity:0,y:-20,height:0},transition:{duration:.4,ease:[.4,0,.2,1]},layout:!0,style:{marginBottom:"2rem",overflow:"hidden"},children:[(0,o.jsx)("h3",{style:{color:"var(--foreground)",fontSize:"1.1rem",fontWeight:600,marginBottom:"0.5rem",fontFamily:"Montserrat, Arial, sans-serif",display:"flex",alignItems:"center",gap:"0.5rem"},children:"\uD83D\uDCDD Choose Scenario"}),(0,o.jsx)("p",{style:{color:"var(--muted-foreground)",fontSize:"0.85rem",marginBottom:"1rem",lineHeight:1.4,fontFamily:"AR One Sans, Arial, sans-serif"},children:k&&R.trim()?'Select a scenario for "'.concat(R,'"'):T?'Select a scenario for "'.concat(null==(r=g.O_.find(e=>e.id===T))?void 0:r.label,'"'):"Select a topic first to choose scenarios"}),T&&(null==(t=g.O_.find(e=>e.id===T))?void 0:t.subtopics)&&(0,o.jsx)("div",{style:{marginBottom:"1rem"},children:(0,o.jsx)("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:"0.75rem"},children:null==(l=g.O_.find(e=>e.id===T))||null==(i=l.subtopics)?void 0:i.map(e=>{let r=E===e;return(0,o.jsx)(d.P.div,{whileHover:{y:-2,scale:1.02},whileTap:{scale:.98},onClick:()=>{A(e),N(""),D(!1),J("")},style:{padding:"0.75rem",borderRadius:12,cursor:"pointer",fontSize:"0.85rem",fontWeight:500,color:"var(--foreground)",fontFamily:"Montserrat, Arial, sans-serif",border:"2px solid ".concat(r?"var(--rose-primary)":"transparent"),background:r?"rgba(126, 90, 117, 0.05)":"var(--card)",boxShadow:r?"0 4px 16px rgba(126, 90, 117, 0.15)":"0 3px 10px rgba(0, 0, 0, 0.12)",transition:"all 0.2s ease",textAlign:"center",minHeight:"50px",display:"flex",alignItems:"center",justifyContent:"center"},children:e},e)})})}),(T||k&&R.trim())&&(0,o.jsx)("div",{style:{marginBottom:"1rem"},children:(0,o.jsxs)(d.P.div,{style:{display:"inline-flex",alignItems:"center",borderRadius:12,border:"2px solid ".concat(I?"var(--rose-primary)":"transparent"),background:I?"rgba(126, 90, 117, 0.05)":"var(--card)",boxShadow:I?"0 4px 16px rgba(126, 90, 117, 0.15)":"0 2px 8px rgba(0, 0, 0, 0.05)",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",overflow:"hidden"},children:[(0,o.jsxs)(d.P.button,{whileHover:{scale:1.02},whileTap:{scale:.98},onClick:()=>{D(!I),I&&N(""),A(""),J("")},style:{padding:"0.6rem 0.8rem",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:"0.6rem",fontWeight:500,color:"var(--foreground)",fontSize:"0.85rem",fontFamily:"Montserrat, Arial, sans-serif",background:"transparent",border:"none",whiteSpace:"nowrap",transition:"all 0.2s ease"},children:[(0,o.jsx)("span",{style:{fontSize:"1.1rem"},children:"✍️"})," Use Custom Scenario"]}),(0,o.jsx)(c.N,{children:I&&(0,o.jsx)(d.P.div,{initial:{width:0,opacity:0},animate:{width:"auto",opacity:1},exit:{width:0,opacity:0},transition:{duration:.3,ease:[.4,0,.2,1]},style:{overflow:"hidden"},children:(0,o.jsx)("input",{type:"text",placeholder:"Enter your custom scenario...",value:_,onChange:e=>N(e.target.value),style:{padding:"0.6rem 0.8rem",border:"none",fontSize:"0.85rem",fontFamily:"inherit",background:"transparent",color:"var(--foreground)",outline:"none",minWidth:"200px",width:"100%"},autoFocus:!0})})})]})})]},"scenarios-section")}),(0,o.jsx)(c.N,{children:Q&&(0,o.jsxs)(d.P.div,{initial:{opacity:0,y:20,height:0},animate:{opacity:1,y:0,height:"auto"},exit:{opacity:0,y:-20,height:0},transition:{duration:.4,ease:[.4,0,.2,1]},layout:!0,style:{marginBottom:"2rem",overflow:"hidden"},children:[(0,o.jsx)("h3",{style:{color:"var(--foreground)",fontSize:"1.1rem",fontWeight:600,marginBottom:"0.5rem",fontFamily:"Montserrat, Arial, sans-serif",display:"flex",alignItems:"center",gap:"0.5rem"},children:"\uD83C\uDFF7️ Conversation Formality"}),(0,o.jsx)("p",{style:{color:"var(--muted-foreground)",fontSize:"0.85rem",marginBottom:"1rem",lineHeight:1.4,fontFamily:"AR One Sans, Arial, sans-serif"},children:"Set the conversation tone and formality level"}),(0,o.jsx)("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(140px, 1fr))",gap:"0.75rem"},children:Object.entries(g.W$).map(e=>{let[r,t]=e,n=t.match(/([\uD800-\uDBFF][\uDC00-\uDFFF]|[\u2600-\u27BF])/),a=n?n[0]:"",i=t.split(":")[0];return(0,o.jsxs)(d.P.div,{whileHover:{y:-2,scale:1.02},whileTap:{scale:.98},onClick:()=>P(r),style:{padding:"0.75rem",borderRadius:12,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:"0.6rem",fontSize:"0.8rem",fontWeight:500,color:"var(--foreground)",fontFamily:"Montserrat, Arial, sans-serif",border:"2px solid ".concat(O===r?"var(--rose-primary)":"transparent"),background:O===r?"rgba(126, 90, 117, 0.05)":"var(--card)",boxShadow:O===r?"0 4px 16px rgba(126, 90, 117, 0.15)":"0 4px 12px rgba(0, 0, 0, 0.15)",transition:"all 0.2s ease",minHeight:"50px"},children:[(0,o.jsx)("div",{style:{fontSize:"1.1rem"},children:a}),(0,o.jsx)("div",{style:{fontWeight:600},children:i})]},r)})})]},"formality-section")}),(0,o.jsx)(c.N,{children:ee&&(null==S?void 0:S.learning_goals)&&S.learning_goals.length>0&&(0,o.jsxs)(d.P.div,{initial:{opacity:0,y:20,height:0},animate:{opacity:1,y:0,height:"auto"},exit:{opacity:0,y:-20,height:0},transition:{duration:.4,ease:[.4,0,.2,1]},layout:!0,style:{marginBottom:"2rem",overflow:"hidden"},children:[(0,o.jsx)("h3",{style:{color:"var(--foreground)",fontSize:"1.1rem",fontWeight:600,marginBottom:"0.5rem",fontFamily:"Montserrat, Arial, sans-serif",display:"flex",alignItems:"center",gap:"0.5rem"},children:"\uD83C\uDFAF Focus on Learning Goal"}),(0,o.jsx)("p",{style:{color:"var(--muted-foreground)",fontSize:"0.85rem",marginBottom:"1rem",lineHeight:1.4,fontFamily:"AR One Sans, Arial, sans-serif"},children:"Choose which skill you want to work on during this session"}),(0,o.jsx)("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:"0.75rem"},children:S.learning_goals.map(e=>{let r=g.Kq.find(r=>r.id===e);return r?(0,o.jsxs)(d.P.div,{whileHover:{y:-2,scale:1.02},whileTap:{scale:.98},onClick:()=>{B(r.id),U([]),L(!0),J(""),ec(300)},style:{padding:"0.75rem",borderRadius:12,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:"0.75rem",fontWeight:500,color:"var(--foreground)",fontSize:"0.85rem",minHeight:"50px",fontFamily:"Montserrat, Arial, sans-serif",border:"2px solid ".concat(F===r.id?"var(--rose-primary)":"transparent"),background:F===r.id?"rgba(126, 90, 117, 0.05)":"var(--card)",boxShadow:F===r.id?"0 4px 16px rgba(126, 90, 117, 0.15)":"0 4px 12px rgba(0, 0, 0, 0.15)",transition:"all 0.2s ease"},children:[(0,o.jsx)("span",{style:{fontSize:"1.1rem"},children:r.icon}),(0,o.jsx)("span",{children:r.goal})]},r.id):null})})]},"goals-section")}),(0,o.jsx)(c.N,{children:M&&F&&(0,o.jsxs)(d.P.div,{initial:{opacity:0,y:20,height:0},animate:{opacity:1,y:0,height:"auto"},exit:{opacity:0,y:-20,height:0},transition:{duration:.4,ease:[.4,0,.2,1]},layout:!0,style:{marginBottom:"2rem",overflow:"hidden"},children:[(0,o.jsx)("h3",{style:{color:"var(--foreground)",fontSize:"1.1rem",fontWeight:600,marginBottom:"0.5rem",fontFamily:"Montserrat, Arial, sans-serif",display:"flex",alignItems:"center",gap:"0.5rem"},children:"\uD83D\uDCCB Choose Specific Subgoals"}),(0,o.jsx)("p",{style:{color:"var(--muted-foreground)",fontSize:"0.85rem",marginBottom:"1rem",lineHeight:1.4,fontFamily:"AR One Sans, Arial, sans-serif"},children:"Select specific skills to focus on (optional - leave empty to work on all)"}),(0,o.jsx)("div",{style:{display:"flex",flexDirection:"column",gap:"0.5rem"},children:(()=>{let e=g.Kq.find(e=>e.id===F);return(null==e?void 0:e.subgoals)?e.subgoals.map(e=>{let r=z.includes(e.id);return(0,o.jsxs)(d.P.div,{whileHover:{scale:1.01},whileTap:{scale:.99},onClick:()=>{var r;return r=e.id,void(U(e=>e.includes(r)?e.filter(e=>e!==r):[...e,r]),J(""))},style:{padding:"0.75rem 1rem",borderRadius:12,cursor:"pointer",display:"flex",alignItems:"center",gap:"0.75rem",fontWeight:500,color:"var(--foreground)",fontSize:"0.8rem",fontFamily:"AR One Sans, Arial, sans-serif",border:"2px solid ".concat(r?"var(--rose-primary)":"transparent"),background:r?"rgba(126, 90, 117, 0.08)":"var(--card)",boxShadow:r?"0 4px 16px rgba(126, 90, 117, 0.15)":"0 2px 8px rgba(0, 0, 0, 0.08)",transition:"all 0.2s ease",lineHeight:1.4},children:[(0,o.jsx)("div",{style:{width:"20px",height:"20px",borderRadius:"6px",border:"2px solid ".concat(r?"var(--rose-primary)":"var(--muted-foreground)"),background:r?"var(--rose-primary)":"transparent",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,transition:"all 0.2s ease"},children:r&&(0,o.jsx)("span",{style:{color:"#fff",fontSize:"0.7rem",fontWeight:"bold"},children:"✓"})}),(0,o.jsx)("span",{children:e.description})]},e.id)}):null})()})]},"subgoals-section")}),(0,o.jsx)(c.N,{children:(_.trim()||E)&&F&&(0,o.jsx)(d.P.div,{initial:{opacity:0,y:20,height:0},animate:{opacity:1,y:0,height:"auto"},exit:{opacity:0,y:-20,height:0},transition:{duration:.4,ease:[.4,0,.2,1]},layout:!0,style:{display:"flex",justifyContent:"center",alignItems:"center",marginTop:"2rem",overflow:"hidden"},children:(0,o.jsx)(d.P.button,{whileHover:{y:-2,scale:1.02},whileTap:{scale:.98},onClick:eu,disabled:q||!b,style:{padding:"0.8rem 1.5rem",borderRadius:16,border:"none",background:q||!b?"var(--muted)":"linear-gradient(135deg, var(--rose-primary) 0%, #8a6a7a 100%)",color:"#fff",fontSize:"1rem",fontWeight:700,cursor:q||!b?"not-allowed":"pointer",fontFamily:"Montserrat, Arial, sans-serif",minWidth:"180px",boxShadow:"0 6px 20px rgba(0, 0, 0, 0.25)",transition:"all 0.2s ease"},children:q?"\uD83D\uDD04 Starting...":"\uD83C\uDFA4 Start Practice Session"})},"action-button")})]})},"modal-overlay")})]}):null}function h(e){let{isOpen:r,onClose:t,onSave:a,isSaving:i,currentTopics:s,currentDescription:l,currentFormality:c}=e,[d,g]=n.useState(""),u=async()=>{if(!d.trim())return void alert("Please enter a persona name");await a(d),g("")};return r?(0,o.jsx)("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0, 0, 0, 0.5)",display:"flex",justifyContent:"center",alignItems:"center",zIndex:1e4},children:(0,o.jsxs)("div",{style:{background:"#fff",borderRadius:16,padding:"2rem",maxWidth:"500px",width:"90%",maxHeight:"80vh",overflowY:"auto",boxShadow:"0 10px 40px rgba(0, 0, 0, 0.2)",border:"1px solid #e0e0e0"},children:[(0,o.jsxs)("div",{style:{textAlign:"center",marginBottom:"1.5rem"},children:[(0,o.jsx)("h2",{style:{color:"var(--rose-primary)",fontSize:"1.5rem",fontWeight:600,marginBottom:"0.5rem",fontFamily:"Gabriela, Arial, sans-serif"},children:"\uD83C\uDFAD Save Conversation Persona"}),(0,o.jsx)("p",{style:{color:"#666",fontSize:"0.9rem",lineHeight:1.4},children:"Create a reusable persona from this conversation to quickly start similar sessions in the future."})]}),(0,o.jsxs)("div",{style:{marginBottom:"1.5rem",padding:"1rem",background:"#f8f9fa",borderRadius:8,border:"1px solid #e9ecef"},children:[(0,o.jsx)("h4",{style:{color:"#495057",fontSize:"0.9rem",fontWeight:600,marginBottom:"0.75rem",fontFamily:"Montserrat, Arial, sans-serif"},children:"\uD83D\uDCCB Current Settings"}),s.length>0&&(0,o.jsxs)("div",{style:{marginBottom:"0.5rem"},children:[(0,o.jsx)("span",{style:{fontSize:"0.8rem",fontWeight:600,color:"#6c757d",marginRight:"0.5rem"},children:"Topics:"}),(0,o.jsx)("span",{style:{fontSize:"0.8rem",color:"#495057",background:"#e9ecef",padding:"0.2rem 0.5rem",borderRadius:4,marginRight:"0.25rem"},children:s.join(", ")})]}),(0,o.jsxs)("div",{style:{marginBottom:"0.5rem"},children:[(0,o.jsx)("span",{style:{fontSize:"0.8rem",fontWeight:600,color:"#6c757d",marginRight:"0.5rem"},children:"Formality:"}),(0,o.jsx)("span",{style:{fontSize:"0.8rem",color:"#495057",background:"#e9ecef",padding:"0.2rem 0.5rem",borderRadius:4},children:c})]}),l&&(0,o.jsxs)("div",{style:{marginBottom:"0.5rem"},children:[(0,o.jsx)("span",{style:{fontSize:"0.8rem",fontWeight:600,color:"#6c757d",marginRight:"0.5rem"},children:"Description:"}),(0,o.jsx)("span",{style:{fontSize:"0.8rem",color:"#495057",background:"#e9ecef",padding:"0.2rem 0.5rem",borderRadius:4},children:l})]})]}),(0,o.jsxs)("div",{style:{marginBottom:"1.5rem"},children:[(0,o.jsx)("label",{style:{display:"block",marginBottom:"0.5rem",fontWeight:600,color:"#333",fontSize:"0.9rem"},children:"Persona Name *"}),(0,o.jsx)("input",{type:"text",value:d,onChange:e=>g(e.target.value),placeholder:"e.g., Business Meeting, Casual Chat, Travel Guide",style:{width:"100%",padding:"0.75rem",border:"1px solid #ddd",borderRadius:8,fontSize:"0.9rem",fontFamily:"AR One Sans, Arial, sans-serif"}})]}),(0,o.jsxs)("div",{style:{display:"flex",gap:"1rem",justifyContent:"flex-end"},children:[(0,o.jsx)("button",{onClick:()=>{g(""),t()},disabled:i,style:{padding:"0.75rem 1.5rem",background:"#f8f9fa",color:"#6c757d",border:"1px solid #dee2e6",borderRadius:8,cursor:i?"not-allowed":"pointer",fontSize:"0.9rem",fontWeight:500,transition:"all 0.2s",opacity:i?.6:1},children:"Skip"}),(0,o.jsx)("button",{onClick:u,disabled:i||!d.trim(),style:{padding:"0.75rem 1.5rem",background:i||!d.trim()?"#ccc":"var(--rose-primary)",color:"#fff",border:"none",borderRadius:8,cursor:i||!d.trim()?"not-allowed":"pointer",fontSize:"0.9rem",fontWeight:600,transition:"all 0.2s",boxShadow:i||!d.trim()?"none":"0 2px 8px rgba(195,141,148,0.2)"},children:i?"\uD83D\uDCBE Saving...":"\uD83D\uDCBE Save Persona"})]})]})}):null}var y=t(7133),S=t(880),x=t(988),b=t.n(x),v=t(6710),T=t(6668),w=t.n(T),E=t(2567),A=t(6822),k=t.n(A);let C={hi:"Devanagari",ja:"Japanese",zh:"Chinese",ko:"Korean",ar:"Arabic",ta:"Tamil",ml:"Malayalam",or:"Odia",th:"Thai",bn:"Bengali",pa:"Punjabi",gu:"Gujarati",mr:"Marathi",kn:"Kannada",te:"Telugu"},I=(e,r)=>{if(!(r in C))return{mainText:e};if(e.includes("(")&&e.includes(")")){let r=e.match(/^(.+?)\s*\(([^)]+)\)$/);if(r||(r=e.match(/^(.+?)\s*\(([^)]+)\)/)))return{mainText:r[1].trim(),romanizedText:r[2].trim()};if(r=e.match(/^\(([^)]+)\)\s*(.+)$/))return{mainText:r[2].trim(),romanizedText:r[1].trim()}}return{mainText:e}},D=null,R=null,j=async()=>D||(R||(R=(async()=>{let e=new y.A;return await e.init(new S.A({dictPath:"/kuromoji/dict"})),D=e,e})()),R),_=(e,r)=>{if(!e||"string"!=typeof e)return{mainText:""};let t=e.match(/^(.+?)\s*\(([^)]+)\)$/);return t?{mainText:t[2].trim(),romanizedText:t[1].trim()}:{mainText:e}},N=async(e,r)=>{if(!(r in C))return e;try{let t="";switch(r){case"ja":{let r=await j();t=(await r.convert(e,{to:"romaji",mode:"spaced"})).replace(/\s*([,.!?;:])/g,"$1").replace(/([,.!?;:])\s+/g,"$1 ").replace(/\s+/g," ").trim();break}case"ko":t=(0,E.C)(e);break;case"zh":try{t=(0,v.iA)(e,{toneType:"symbol"})}catch(r){console.warn("pinyin-pro failed, falling back to pinyin:",r),t=b()(e,{style:b().STYLE_TONE}).join(" ")}break;case"hi":t=k().t(e,"devanagari","iast");break;default:t=w()(e)}return t}catch(t){return console.error("Error romanizing text for language ".concat(r,":"),t),e}},O=async(e,r)=>{try{console.log("\uD83D\uDD0D [AUDIO_SERVICE] Processing audio transcription:",{audioBlobSize:e.size,audioBlobType:e.type,language:r});let t=new FormData;t.append("audio",e,"recording.webm"),t.append("language",r);let o=localStorage.getItem("jwt"),n=await s.A.post("/api/transcribe_only",t,{headers:{"Content-Type":"multipart/form-data",...o?{Authorization:"Bearer ".concat(o)}:{}}}),a=n.data.transcription||"Speech recorded";return console.log("\uD83D\uDD0D [AUDIO_SERVICE] Transcription response:",{transcription:a,responseData:n.data}),a}catch(e){throw console.error("Error processing audio transcription:",e),e}},P=async(e,r,t,o,n)=>{try{var a,i,l;console.log("\uD83D\uDD0D [AI_RESPONSE] Getting AI response for transcription:",e);let c=localStorage.getItem("jwt"),d={transcription:e,chat_history:r,language:t,user_level:(null==o?void 0:o.userLevel)||"beginner",user_topics:(null==o?void 0:o.topics)||[],user_goals:(null==n?void 0:n.learning_goals)?"string"==typeof n.learning_goals?JSON.parse(n.learning_goals):n.learning_goals:[],formality:(null==o?void 0:o.formality)||"friendly",feedback_language:(null==o?void 0:o.feedbackLanguage)||"en"};console.log("\uD83D\uDD0D [AI_RESPONSE] Request data:",d);let g=await s.A.post("/api/ai_response",d,{headers:{"Content-Type":"application/json",...c?{Authorization:"Bearer ".concat(c)}:{}}});console.log("\uD83D\uDD0D [AI_RESPONSE] Response received:",g.data);let u=(null==(a=g.data)?void 0:a.response)||(null==(i=g.data)?void 0:i.ai_response)||(null==(l=g.data)?void 0:l.message);return console.log("\uD83D\uDD0D [AI_RESPONSE] Extracted AI response:",u),u}catch(e){throw console.error("Error getting AI response:",e),e}},F=async(e,r)=>{try{let t=localStorage.getItem("jwt");return(await s.A.post("/api/short_feedback",{transcription:e,language:r},{headers:{"Content-Type":"application/json",...t?{Authorization:"Bearer ".concat(t)}:{}}})).data.feedback||""}catch(e){return console.error("Error getting short feedback:",e),""}},B=null,z=!1,U=()=>{B&&(console.log("\uD83D\uDD0A [TTS_MANAGER] Stopping current TTS audio"),B.pause(),B=null),z=!1},M=async(e,r,t,o)=>{try{U();let n=(e=>{let r=e.replace(/\*\*(.*?)\*\*/g,"$1").replace(/\*(.*?)\*/g,"$1").replace(/`(.*?)`/g,"$1").replace(/#{1,6}\s/g,"").replace(/\[([^\]]+)\]\([^)]+\)/g,"$1").replace(/!\[([^\]]*)\]\([^)]+\)/g,"$1").replace(/\n+/g," ").replace(/\s+/g," ").trim();return r=r.replace(/[^\w\s.,!?;:'"-]/g,"")})(e),a=localStorage.getItem("jwt");console.log("\uD83D\uDD0A [TTS_MANAGER] Starting TTS for:",n.substring(0,50));let i=await s.A.post("/api/tts",{text:n,language:r,cacheKey:t},{headers:{"Content-Type":"application/json",...a?{Authorization:"Bearer ".concat(a)}:{}}});if(i.data.ttsUrl){let e=new Audio(i.data.ttsUrl);B=e,z=!0,o&&o(!0),e.onended=()=>{console.log("\uD83D\uDD0A [TTS_MANAGER] TTS finished playing"),B=null,z=!1,o&&o(!1)},e.onerror=e=>{console.error("\uD83D\uDD0A [TTS_MANAGER] TTS audio error:",e),B=null,z=!1},await e.play(),console.log("\uD83D\uDD0A [TTS_MANAGER] TTS started playing successfully")}}catch(e){var n,a;console.error("\uD83D\uDD0A [TTS_MANAGER] TTS request failed:",e),B=null,z=!1,o&&o(!1),(null==(n=e.response)?void 0:n.status)===503?console.warn("\uD83D\uDD0A TTS service is temporarily unavailable."):(null==(a=e.response)?void 0:a.status)===500?console.warn("\uD83D\uDD0A TTS generation failed."):console.warn("\uD83D\uDD0A TTS request failed:",e.message)}},L=async(e,r,t,o,n,a,i)=>{try{console.log("\uD83D\uDD0D [PIPELINE] Starting audio processing pipeline..."),console.log("\uD83D\uDD0D [PIPELINE] Audio blob size:",e.size,"bytes"),console.log("\uD83D\uDD0D [PIPELINE] Language:",r),console.log("\uD83D\uDD0D [PIPELINE] Chat history length:",t.length),console.log("\uD83D\uDD0D [PIPELINE] Step 1: Getting transcription...");let s=await O(e,r);console.log("\uD83D\uDD0D [PIPELINE] Transcription received:",s);let l="";r in C&&"Speech recorded"!==s&&(l=await N(s,r));let c={sender:"User",text:s,romanizedText:l,timestamp:new Date,isFromOriginalConversation:!1},d="";n&&a&&"Speech recorded"!==s&&(d=await F(s,r)),console.log("\uD83D\uDD0D [PIPELINE] Step 3: Getting AI response...");let g=[...t,c];console.log("\uD83D\uDD0D [PIPELINE] Updated chat history length:",g.length);let u=await P(s,g,r,o,i);console.log("\uD83D\uDD0D [PIPELINE] AI response received:",u);let p=null;u&&(p=_(u,r));let f=p?{sender:"AI",text:p.mainText,romanizedText:p.romanizedText||"",timestamp:new Date,isFromOriginalConversation:!1}:null,m={userMessage:c,aiMessage:f,shortFeedback:d,transcription:s};return console.log("\uD83D\uDD0D [PIPELINE] Pipeline completed successfully:",m),m}catch(e){throw console.error("\uD83D\uDD0D [PIPELINE] Error in audio processing pipeline:",e),e}},G=e=>{var r,t,n,a;let{isDarkMode:i,language:s,chatHistory:l,userPreferences:c}=e;return(0,o.jsx)("div",{style:{padding:"0.75rem 1.25rem",background:i?"linear-gradient(135deg, var(--muted) 0%, rgba(255,255,255,0.02) 100%)":"linear-gradient(135deg, rgba(195,141,148,0.08) 0%, rgba(195,141,148,0.03) 100%)",borderBottom:i?"1px solid var(--border)":"1px solid rgba(195,141,148,0.15)",display:"flex",justifyContent:"space-between",alignItems:"center",borderTopLeftRadius:24,borderTopRightRadius:24,transition:"all 0.3s ease",boxShadow:"0 2px 8px rgba(195,141,148,0.1)"},children:(0,o.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",paddingLeft:"2.5rem",paddingRight:"2rem",paddingTop:"0.25rem",paddingBottom:"0.25rem",width:"100%"},children:[(0,o.jsxs)("div",{style:{color:i?"#e8b3c3":"var(--rose-primary)",fontWeight:700,fontSize:"1.2rem",fontFamily:"Gabriela, Arial, sans-serif",transition:"color 0.3s ease",whiteSpace:"nowrap",flexShrink:0},children:[{en:"English",es:"Spanish",fr:"French",zh:"Mandarin",ja:"Japanese",ko:"Korean",tl:"Tagalog",hi:"Hindi",ml:"Malayalam",ta:"Tamil",or:"Odia"}[s]||"English"," Practice Session"]}),l.length>0&&(0,o.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"0.3rem",flexWrap:"nowrap",justifyContent:"flex-end",flex:1,marginLeft:"auto",overflowX:"auto",overflowY:"hidden",minWidth:0},children:[null==c||null==(r=c.topics)?void 0:r.map((e,r)=>(0,o.jsx)(d.P.span,{style:{background:i?"rgba(196,181,253,0.15)":"rgba(132,84,109,0.1)",color:i?"var(--light-purple)":"var(--rose-primary)",padding:"0.35rem 0.6rem",borderRadius:"16px",fontSize:"0.85rem",fontWeight:600,border:i?"1px solid rgba(196,181,253,0.3)":"1px solid rgba(132,84,109,0.2)",whiteSpace:"nowrap",fontFamily:"Montserrat, Arial, sans-serif",boxShadow:i?"0 2px 8px rgba(196,181,253,0.1)":"0 2px 8px rgba(132,84,109,0.08)",backdropFilter:"blur(10px)",display:"inline-block",flexShrink:0,cursor:"pointer",position:"relative"},initial:{opacity:0,scale:.8,y:10},animate:{opacity:1,scale:1,y:0},transition:{duration:1.2,delay:.25*r,ease:"easeOut"},whileHover:{scale:1.05,y:-2,boxShadow:i?"0 4px 15px rgba(196,181,253,0.2)":"0 4px 15px rgba(132,84,109,0.15)",transition:{duration:.4}},whileTap:{scale:.95},onMouseEnter:r=>{r.currentTarget.style.padding="0.35rem 0.8rem",r.currentTarget.innerHTML="\uD83D\uDCAC ".concat(e)},onMouseLeave:e=>{e.currentTarget.style.padding="0.35rem 0.6rem",e.currentTarget.innerHTML="\uD83D\uDCAC"},children:"\uD83D\uDCAC"},r)),(null==c?void 0:c.formality)&&(0,o.jsx)(d.P.span,{style:{background:i?"rgba(139,163,217,0.15)":"rgba(59,83,119,0.1)",color:"var(--blue-secondary)",padding:"0.35rem 0.6rem",borderRadius:"16px",fontSize:"0.85rem",fontWeight:600,border:i?"1px solid rgba(139,163,217,0.3)":"1px solid rgba(59,83,119,0.2)",whiteSpace:"nowrap",fontFamily:"Montserrat, Arial, sans-serif",boxShadow:i?"0 2px 8px rgba(139,163,217,0.1)":"0 2px 8px rgba(59,83,119,0.08)",backdropFilter:"blur(10px)",cursor:"pointer",position:"relative"},initial:{opacity:0,scale:.8,y:10},animate:{opacity:1,scale:1,y:0},transition:{duration:1.2,delay:.25*((null==c||null==(t=c.topics)?void 0:t.length)||0)+.3,ease:"easeOut"},whileHover:{scale:1.05,y:-2,boxShadow:i?"0 4px 15px rgba(139,163,217,0.2)":"0 4px 15px rgba(59,83,119,0.15)",transition:{duration:.4}},whileTap:{scale:.95},onMouseEnter:e=>{e.currentTarget.style.padding="0.35rem 0.8rem",e.currentTarget.innerHTML="\uD83C\uDFAD ".concat(c.formality)},onMouseLeave:e=>{e.currentTarget.style.padding="0.35rem 0.6rem",e.currentTarget.innerHTML="\uD83C\uDFAD"},children:"\uD83C\uDFAD"}),null==c||null==(n=c.user_goals)?void 0:n.map((e,r)=>{var t;let n=g.Kq.find(r=>r.id===e);return n?(0,o.jsx)(d.P.span,{style:{background:i?"rgba(240,200,208,0.15)":"rgba(214,182,182,0.1)",color:"var(--rose-accent)",padding:"0.35rem 0.6rem",borderRadius:"16px",fontSize:"0.85rem",fontWeight:600,border:i?"1px solid rgba(240,200,208,0.3)":"1px solid rgba(214,182,182,0.2)",whiteSpace:"nowrap",fontFamily:"Montserrat, Arial, sans-serif",boxShadow:i?"0 2px 8px rgba(240,200,208,0.1)":"0 2px 8px rgba(214,182,182,0.08)",backdropFilter:"blur(10px)",display:"inline-block",flexShrink:0,cursor:"pointer",position:"relative"},initial:{opacity:0,scale:.8,y:10},animate:{opacity:1,scale:1,y:0},transition:{duration:1.2,delay:(((null==c||null==(t=c.topics)?void 0:t.length)||0)+ +(null!=c&&!!c.formality))*.25+.25*r+.5,ease:"easeOut"},whileHover:{scale:1.05,y:-2,boxShadow:i?"0 4px 15px rgba(240,200,208,0.2)":"0 4px 15px rgba(214,182,182,0.15)",transition:{duration:.4}},whileTap:{scale:.95},onMouseEnter:e=>{e.currentTarget.style.padding="0.35rem 0.8rem",e.currentTarget.innerHTML="".concat(n.icon," ").concat(n.goal)},onMouseLeave:e=>{e.currentTarget.style.padding="0.35rem 0.6rem",e.currentTarget.innerHTML=n.icon},children:n.icon},r):null}),null==c||null==(a=c.selected_subgoals)?void 0:a.map((e,r)=>{var t,n,a;let s="";for(let r of g.Kq){let t=null==(a=r.subgoals)?void 0:a.find(r=>r.id===e);if(t){s=t.description;break}}if(!s)return null;let l=s.length>40?s.substring(0,40)+"...":s;return(0,o.jsx)(d.P.span,{style:{background:i?"rgba(147,197,153,0.15)":"rgba(147,197,153,0.1)",color:i?"#93C599":"#4a8a50",padding:"0.35rem 0.6rem",borderRadius:"16px",fontSize:"0.85rem",fontWeight:600,border:i?"1px solid rgba(147,197,153,0.3)":"1px solid rgba(147,197,153,0.2)",whiteSpace:"nowrap",fontFamily:"Montserrat, Arial, sans-serif",boxShadow:i?"0 2px 8px rgba(147,197,153,0.1)":"0 2px 8px rgba(147,197,153,0.08)",backdropFilter:"blur(10px)",display:"inline-block",flexShrink:0,cursor:"pointer",position:"relative"},initial:{opacity:0,scale:.8,y:10},animate:{opacity:1,scale:1,y:0},transition:{duration:1.2,delay:(((null==c||null==(t=c.topics)?void 0:t.length)||0)+ +(null!=c&&!!c.formality)+((null==c||null==(n=c.user_goals)?void 0:n.length)||0))*.25+.25*r+.6,ease:"easeOut"},whileHover:{scale:1.05,y:-2,boxShadow:i?"0 4px 15px rgba(147,197,153,0.2)":"0 4px 15px rgba(147,197,153,0.15)",transition:{duration:.4}},whileTap:{scale:.95},onMouseEnter:e=>{e.currentTarget.style.padding="0.35rem 0.8rem",e.currentTarget.innerHTML="\uD83D\uDCCB ".concat(l)},onMouseLeave:e=>{e.currentTarget.style.padding="0.35rem 0.6rem",e.currentTarget.innerHTML="\uD83D\uDCCB"},children:"\uD83D\uDCCB"},e)})]})]})})},W=e=>{let{isDarkMode:r,panelWidths:t,showShortFeedbackPanel:n,setShowShortFeedbackPanel:a,ttsDebugInfo:i,setTtsDebugInfo:s,romanizationDebugInfo:l,setRomanizationDebugInfo:c,translations:d,showTranslations:g,feedbackExplanations:u,showDetailedBreakdown:p,setShowDetailedBreakdown:f,parsedBreakdown:m,activePopup:h,shortFeedback:y,quickTranslations:S,showQuickTranslation:x,setShowQuickTranslation:b,llmBreakdown:v,showLlmBreakdown:T,setShowLlmBreakdown:w,chatHistory:E,isLoadingMessageFeedback:A,isLoadingExplain:k,explainLLMResponse:C,handleRequestDetailedBreakdown:I,renderClickableMessage:D,language:R,userPreferences:j,children:_}=e;return(0,o.jsxs)("div",{className:"analyze-page",style:{display:"flex",flexDirection:"column",height:"calc(100vh - 5rem)",width:"100%",background:r?"linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%)":"linear-gradient(135deg, #f9f6f4 0%, #f5f1ec 50%, #e8e0d8 100%)",padding:"0.5rem 0.5rem 0 0.5rem",gap:"0.5rem",transition:"all 0.15s ease",fontFamily:"Montserrat, Arial, sans-serif",position:"relative",overflow:"hidden",boxSizing:"border-box"},children:[!1,!1,(0,o.jsx)(G,{isDarkMode:r,language:R,chatHistory:E,userPreferences:j}),(0,o.jsxs)("div",{style:{display:"flex",flex:1,gap:"0.5rem",minHeight:0},children:[n&&(0,o.jsxs)("div",{className:"panel-hover",style:{width:"".concat(100*t.left,"%"),background:r?"linear-gradient(135deg, var(--card) 0%, rgba(255,255,255,0.02) 100%)":"linear-gradient(135deg, #ffffff 0%, rgba(59,83,119,0.02) 100%)",borderRadius:24,display:"flex",flexDirection:"column",boxShadow:r?"0 8px 32px rgba(139,163,217,0.2), 0 2px 8px rgba(139,163,217,0.1)":"0 8px 32px rgba(59,83,119,0.25), 0 2px 8px rgba(59,83,119,0.15)",position:"relative",transition:"all 0.15s ease",border:r?"1px solid rgba(139,163,217,0.3)":"1px solid #3b5377",backdropFilter:"blur(20px)",zIndex:1,overflow:"auto",height:"100%"},children:[(0,o.jsx)("div",{style:{background:"linear-gradient(135deg, #3b5377 0%, #2a3d5a 100%)",color:"#ffffff",padding:"0.75rem 1.25rem",borderRadius:"24px 24px 0 0",textAlign:"center",borderBottom:r?"1px solid rgba(139,163,217,0.3)":"1px solid #3b5377",fontFamily:"Gabriela, Arial, sans-serif",fontWeight:700,fontSize:"1rem",display:"flex",justifyContent:"space-between",alignItems:"center",transition:"all 0.3s ease",boxShadow:r?"0 4px 16px rgba(139,163,217,0.2)":"0 4px 16px rgba(59,83,119,0.15)",position:"sticky",top:0,zIndex:2},children:(0,o.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",paddingLeft:"0.2rem",paddingRight:"0.2rem",paddingTop:"0.25rem",paddingBottom:"0.25rem",width:"100%"},children:[(0,o.jsx)("div",{style:{color:"#ffffff",fontWeight:700,fontSize:"1.2rem",fontFamily:"Gabriela, Arial, sans-serif",transition:"color 0.3s ease",whiteSpace:"nowrap",flexShrink:0},children:"\uD83D\uDCA1 AI Explanations"}),(0,o.jsx)("button",{onClick:()=>a(!1),style:{background:"none",border:"none",color:"#ffffff",fontSize:"1.1rem",cursor:"pointer",padding:"0.2rem",borderRadius:"4px",transition:"all 0.2s"},title:"Hide panel",children:"◀"})]})}),(0,o.jsx)("div",{onMouseDown:()=>{},style:{position:"absolute",right:-4,top:0,bottom:0,width:8,cursor:"col-resize",background:"transparent",zIndex:10}}),(0,o.jsxs)("div",{style:{flex:1,display:"flex",flexDirection:"column",minHeight:0,overflowY:"auto"},children:[Object.keys(S).length>0&&(0,o.jsxs)("div",{style:{background:r?"linear-gradient(135deg, rgba(132,84,109,0.15) 0%, rgba(132,84,109,0.08) 100%)":"linear-gradient(135deg, rgba(132,84,109,0.12) 0%, rgba(132,84,109,0.06) 100%)",color:r?"var(--foreground)":"#3e3e3e",padding:"1rem",borderBottom:r?"1px solid rgba(195,141,148,0.3)":"1px solid #c38d94",fontSize:"0.85rem",lineHeight:1.5,fontFamily:"AR One Sans, Arial, sans-serif",fontWeight:400,transition:"background 0.3s ease, color 0.3s ease"},children:[(0,o.jsxs)("div",{style:{fontWeight:600,fontSize:"1.1rem",marginBottom:x?"1rem":"0",color:"#84546d",display:"flex",alignItems:"center",justifyContent:"space-between"},children:[(0,o.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[(0,o.jsx)("span",{children:"Quick Translation"}),T&&(0,o.jsx)("button",{onClick:()=>b(!x),style:{padding:"0.15rem 0.4rem",borderRadius:3,border:"1px solid #666",background:"rgba(102,102,102,0.1)",color:"#666",fontSize:"0.6rem",cursor:"pointer",transition:"all 0.2s ease"},title:x?"Collapse":"Expand",children:x?"▼":"▶"})]}),(0,o.jsx)("button",{onClick:()=>{let e=-1;for(let r=E.length-1;r>=0;r--)if(E[r]&&"AI"===E[r].sender){e=r;break}if(e>=0){let r=E[e];r&&C(e,r.text)}},disabled:k,style:{padding:"0.35rem 0.7rem",borderRadius:6,border:"1px solid ".concat(r?"rgba(139,163,217,0.6)":"#3b5377"),background:r?"rgba(139,163,217,0.15)":"rgba(59,83,119,0.08)",color:r?"#8ba3d9":"#3b5377",fontSize:"0.7rem",cursor:k?"not-allowed":"pointer",transition:"all 0.2s ease",opacity:k?.6:1,fontWeight:500,boxShadow:r?"0 1px 3px rgba(139,163,217,0.10)":"0 1px 3px rgba(59,83,119,0.10)"},title:"Get detailed LLM breakdown",children:k?"\uD83D\uDD04 Explaining...":"\uD83D\uDCDD Detailed Explanation"})]}),x&&(0,o.jsx)("div",{style:{maxHeight:T?"200px":"none",overflowY:T?"auto":"visible"},children:Object.entries(S).map(e=>{let[t,n]=e;return(0,o.jsx)("div",{style:{marginBottom:"1rem"},children:n.error?(0,o.jsx)("div",{style:{color:"#dc3545",fontStyle:"italic"},children:n.fullTranslation}):(0,o.jsxs)("div",{children:[(0,o.jsxs)("div",{style:{marginBottom:"0.5rem"},children:[(0,o.jsx)("strong",{children:"Word by Word Breakdown:"}),(0,o.jsx)("div",{style:{background:r?"#334155":"#f8f9fa",padding:"0.75rem",borderRadius:8,marginTop:"0.5rem",fontSize:"0.95rem",lineHeight:"1.6",maxHeight:T?"120px":"none",overflowY:T?"auto":"visible"},children:D(E[parseInt(t)],parseInt(t),n)})]}),n.fullTranslation&&(0,o.jsxs)("div",{style:{marginBottom:"0.5rem"},children:[(0,o.jsx)("strong",{children:"Translation:"}),(0,o.jsx)("div",{style:{background:r?"#334155":"#f8f9fa",padding:"0.75rem",borderRadius:8,marginTop:"0.5rem",fontSize:"0.85rem",lineHeight:"1.6"},children:n.fullTranslation})]})]})},t)})})]}),T&&v&&(0,o.jsxs)("div",{style:{background:r?"linear-gradient(135deg, rgba(60,76,115,0.15) 0%, rgba(60,76,115,0.08) 100%)":"linear-gradient(135deg, rgba(60,76,115,0.12) 0%, rgba(60,76,115,0.06) 100%)",color:r?"var(--foreground)":"#3e3e3e",padding:"1rem",borderBottom:r?"1px solid rgba(139,163,217,0.3)":"1px solid #3b5377",fontSize:"0.85rem",lineHeight:1.5,fontFamily:"AR One Sans, Arial, sans-serif",fontWeight:400,transition:"background 0.3s ease, color 0.3s ease"},children:[(0,o.jsxs)("div",{style:{fontWeight:600,fontSize:"1.1rem",marginBottom:"1rem",color:"#3b5377",display:"flex",alignItems:"center",justifyContent:"space-between"},children:[(0,o.jsx)("span",{children:"LLM Response Breakdown"}),(0,o.jsx)("button",{onClick:()=>w(!1),style:{padding:"0.15rem 0.4rem",borderRadius:3,border:"1px solid #666",background:"rgba(102,102,102,0.1)",color:"#666",fontSize:"0.6rem",cursor:"pointer",transition:"all 0.2s ease"},title:"Hide breakdown",children:"✕"})]}),(0,o.jsx)("div",{style:{background:r?"#334155":"#f8f9fa",padding:"0.75rem",borderRadius:8,fontSize:"0.85rem",lineHeight:"1.6",whiteSpace:"pre-wrap"},children:v})]}),!y&&0===Object.keys(S).length&&!T&&(0,o.jsx)("div",{style:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",padding:"2rem",color:r?"#94a3b8":"#666",fontSize:"0.85rem",textAlign:"center",fontStyle:"italic"},children:(0,o.jsx)("div",{children:"\uD83D\uDCA1 Click on any AI message to see explanations and feedback here"})})]})]}),(0,o.jsx)("div",{style:{width:"".concat(100*t.center,"%"),background:r?"linear-gradient(135deg, var(--card) 0%, rgba(255,255,255,0.02) 100%)":"linear-gradient(135deg, #ffffff 0%, rgba(195,141,148,0.02) 100%)",borderRadius:24,display:"flex",flexDirection:"column",boxShadow:r?"0 8px 40px rgba(0,0,0,0.4), 0 2px 8px rgba(0,0,0,0.2)":"0 8px 40px rgba(60,60,60,0.12), 0 2px 8px rgba(195,141,148,0.08)",position:"relative",transition:"all 0.3s ease",border:"1px solid var(--rose-primary)",backdropFilter:"blur(20px)",zIndex:1,minHeight:0,height:"100%",overflow:"hidden"},children:_}),!n&&(0,o.jsx)("button",{onClick:()=>a(!0),style:{position:"fixed",left:"1rem",top:"6.7rem",background:"var(--blue-secondary)",color:"#fff",border:"none",borderRadius:"12px 0 0 12px",padding:"1.1rem 0.75rem",fontSize:"1.2rem",cursor:"pointer",fontWeight:600,transition:"all 0.3s ease",boxShadow:"0 4px 16px rgba(60,76,115,0.25)",zIndex:1e3,fontFamily:"Montserrat, Arial, sans-serif",height:"60px",display:"flex",alignItems:"center",justifyContent:"center"},title:"Show Short Feedback Panel",children:"\uD83D\uDCA1"})]})]})},H=e=>{let{isDarkMode:r,isRecording:t,onStartRecording:n,onStopRecording:a,autoSpeak:i,setAutoSpeak:s,enableShortFeedback:l,setEnableShortFeedback:c,onEndChat:g}=e;return(0,o.jsx)("div",{style:{width:"100%",padding:"1rem",background:r?"linear-gradient(135deg, var(--muted) 0%, rgba(255,255,255,0.02) 100%)":"linear-gradient(135deg, rgba(195,141,148,0.08) 0%, rgba(195,141,148,0.03) 100%)",borderTop:r?"1px solid var(--border)":"1px solid #e0e0e0",textAlign:"center",transition:"all 0.3s ease",boxShadow:"0 -4px 12px rgba(0,0,0,0.05)",zIndex:10,flexShrink:0,height:"120px",position:"sticky",bottom:0},children:(0,o.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",height:"100%",minHeight:"60px"},children:[(0,o.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem",flex:1},children:[(0,o.jsx)(d.P.button,{onClick:()=>s(!i),whileHover:{scale:1.05},whileTap:{scale:.95},style:{background:"linear-gradient(135deg, var(--blue-secondary) 0%, #5a6b8a 100%)",color:"#fff",border:"none",borderRadius:12,padding:"0.6rem 1rem",cursor:"pointer",fontWeight:600,fontSize:"0.8rem",transition:"all 0.3s ease",boxShadow:"0 6px 24px rgba(60,76,115,0.25), 0 2px 8px rgba(60,76,115,0.15)",minWidth:"110px",fontFamily:"Montserrat, Arial, sans-serif",transform:"translateZ(0)"},children:i?"✅ Autospeak ON":"Autospeak OFF"}),(0,o.jsx)(d.P.button,{onClick:()=>c(!l),whileHover:{scale:1.05},whileTap:{scale:.95},style:{background:l?"linear-gradient(135deg, var(--blue-secondary) 0%, #5a6b8a 100%)":"linear-gradient(135deg, var(--rose-primary) 0%, #8a6a7a 100%)",color:"#fff",border:"none",borderRadius:12,padding:"0.6rem 1rem",cursor:"pointer",fontWeight:600,fontSize:"0.8rem",transition:"all 0.3s ease",boxShadow:"0 6px 24px rgba(60,76,115,0.25), 0 2px 8px rgba(60,76,115,0.15)",minWidth:"110px",fontFamily:"Montserrat, Arial, sans-serif",transform:"translateZ(0)"},children:l?"\uD83D\uDCA1 Short Feedback ON":"Short Feedback OFF"})]}),(0,o.jsx)("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",gap:"0.75rem",flex:1},children:(0,o.jsx)(d.P.button,{onClick:t?a:n,whileHover:{scale:1.05},whileTap:{scale:.95},style:{width:"80px",height:"80px",borderRadius:"50%",border:"none",background:t?"linear-gradient(135deg, #ef4444 0%, #dc2626 100%)":"linear-gradient(135deg, var(--rose-primary) 0%, #8a6a7a 100%)",color:"#fff",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"2rem",fontWeight:"bold",transition:"all 0.3s ease",boxShadow:t?"0 8px 32px rgba(239,68,68,0.4), 0 4px 16px rgba(239,68,68,0.2)":"0 8px 32px rgba(195,141,148,0.4), 0 4px 16px rgba(195,141,148,0.2)",opacity:1,transform:"translateZ(0)"},children:t?"⏹️":"\uD83C\uDFA4"})}),(0,o.jsx)("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem",flex:1,justifyContent:"flex-end"},children:(0,o.jsx)(d.P.button,{onClick:g,whileHover:{scale:1.05},whileTap:{scale:.95},style:{background:"linear-gradient(135deg, var(--rose-primary) 0%, #8a6a7a 100%)",color:"#fff",border:"none",borderRadius:12,padding:"0.6rem 1rem",cursor:"pointer",fontWeight:600,fontSize:"0.85rem",transition:"all 0.3s ease",boxShadow:"0 6px 24px rgba(60,76,115,0.25), 0 2px 8px rgba(60,76,115,0.15)",minWidth:"110px",fontFamily:"Montserrat, Arial, sans-serif",transform:"translateZ(0)"},title:"End chat, generate summary, and return to dashboard",children:"\uD83C\uDFE0 End Chat"})})]})})},V=e=>{let{isDarkMode:r,children:t,isRecording:n,onStartRecording:a,onStopRecording:i,autoSpeak:s,setAutoSpeak:l,enableShortFeedback:c,setEnableShortFeedback:d,onEndChat:g}=e;return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("div",{style:{flex:1,padding:"1.5rem",display:"flex",flexDirection:"column",gap:"1rem",overflowY:"auto",minHeight:0},children:t}),(0,o.jsx)(H,{isDarkMode:r,isRecording:n,onStartRecording:a,onStopRecording:i,autoSpeak:s,setAutoSpeak:l,enableShortFeedback:c,setEnableShortFeedback:d,onEndChat:g})]})};if("undefined"!=typeof document){let e=document.createElement("style");e.textContent="\n  @keyframes spin {\n    0% { transform: rotate(0deg); }\n    100% { transform: rotate(360deg); }\n  }\n",document.head.appendChild(e)}let q=n.memo(e=>{let{message:r,formatted:t,isDarkMode:a,index:i,isLastMessage:s,isLastAIMessage:l,toggleShortFeedback:c,toggleDetailedFeedback:d,generateTTSForText:g,language:u,userPreferences:p,playTTS:f,getTTSText:m,isLoadingMessageFeedback:h,isLoadingExplain:y,isTranslating:S,isGeneratingTTS:x,isPlayingTTS:b,quickTranslation:v,onExplainLLMResponse:T,handleSuggestionButtonClick:w,isLoadingSuggestions:E,playExistingTTS:A,showCorrectedVersions:k,extractCorrectedVersion:C,renderFormattedText:I}=e,D="User"===r.sender,R=(0,n.useMemo)(()=>({padding:"1rem 1.25rem",borderRadius:D?"24px 24px 8px 24px":"24px 24px 24px 8px",background:D?"linear-gradient(135deg, var(--rose-primary) 0%, #8a6a7a 100%)":a?"linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%)":"linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%)",color:D?"#fff":"var(--foreground)",border:D?"none":a?"1px solid var(--border)":"1px solid rgba(195,141,148,0.2)",boxShadow:D?"0 8px 32px rgba(195,141,148,0.3), 0 2px 8px rgba(195,141,148,0.2)":"0 8px 32px rgba(60,76,115,0.12), 0 2px 8px rgba(60,76,115,0.08)",maxWidth:"80%",wordWrap:"break-word",fontWeight:D?600:400,fontFamily:"AR One Sans, Arial, sans-serif",backdropFilter:"blur(20px)",transform:"translateZ(0)"}),[D,a]),j=(0,n.useCallback)(()=>{console.log("\uD83D\uDD0A [LISTEN_BUTTON] Clicked on message:",i),console.log("\uD83D\uDD0A [LISTEN_BUTTON] Message:",r),console.log("\uD83D\uDD0A [LISTEN_BUTTON] User preferences:",p),console.log("\uD83D\uDD0A [LISTEN_BUTTON] Language:",u);let e=m(r,p.romanizationDisplay);console.log("\uD83D\uDD0A [LISTEN_BUTTON] Generated TTS text:",e);let t="message_".concat(i);console.log("\uD83D\uDD0A [LISTEN_BUTTON] Cache key:",t),console.log("\uD83D\uDD0A [LISTEN_BUTTON] Calling playTTS..."),f(e,u,t)},[r,p,i,u,f,m]);(0,n.useCallback)(()=>{c(i)},[i,c]);let _=(0,n.useCallback)(()=>{d(i)},[i,d]);return(0,o.jsxs)("div",{style:{width:"100%",display:"flex",flexDirection:"column",alignItems:D?"flex-end":"flex-start",marginBottom:"1rem",paddingRight:D?"0":"2rem",paddingLeft:D?"2rem":"0"},children:[(0,o.jsx)("div",{style:R,children:(0,o.jsxs)("div",{style:{display:"flex",flexDirection:"column"},children:[(0,o.jsx)("span",{style:{fontSize:"0.9rem",opacity:r.isProcessing?.7:1,fontStyle:r.isProcessing?"italic":"normal"},children:r.isProcessing?(0,o.jsxs)("span",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[(0,o.jsx)("span",{style:{display:"inline-block",width:"12px",height:"12px",border:"2px solid #ccc",borderTop:"2px solid #007bff",borderRadius:"50%",animation:"spin 1s linear infinite"}}),t.mainText]}):r.detailedFeedback||"string"==typeof t.mainText&&(t.mainText.includes("__")||t.mainText.includes("~~")||t.mainText.includes("==")||t.mainText.includes("<<"))?I(t.mainText,i):t.mainText}),t.romanizedText&&(0,o.jsx)("span",{style:{fontSize:"0.85em",color:D?"#ffffff":a?"#94a3b8":"#555",opacity:.8,marginTop:4},children:r.detailedFeedback||"string"==typeof t.romanizedText&&(t.romanizedText.includes("__")||t.romanizedText.includes("~~")||t.romanizedText.includes("==")||t.romanizedText.includes("<<"))?I(t.romanizedText,i):t.romanizedText})]})}),r.detailedFeedback&&k[i]&&(0,o.jsx)("div",{style:{width:"100%",display:"flex",flexDirection:"column",alignItems:D?"flex-end":"flex-start",marginTop:"0.5rem",animation:"slideDown 0.5s ease-out forwards",overflow:"hidden"},children:(0,o.jsxs)("div",{style:{padding:"0.5rem 0.8rem",borderRadius:D?"8px 8px 2px 8px":"8px 8px 8px 2px",background:a?"rgba(16, 185, 129, 0.25)":"rgba(16, 185, 129, 0.2)",color:a?"#10b981":"#047857",fontSize:"0.85rem",fontWeight:400,maxWidth:"70%",wordWrap:"break-word",border:"1px solid ".concat(a?"rgba(16, 185, 129, 0.4)":"rgba(16, 185, 129, 0.3)"),position:"relative"},children:[(0,o.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"0.3rem",marginBottom:"0.2rem",fontSize:"0.75rem",opacity:.7,fontWeight:500},children:[(0,o.jsx)("span",{children:"✓"}),(0,o.jsx)("span",{children:"Corrected"})]}),(()=>{let e=C(r.detailedFeedback);return e?(0,o.jsxs)("div",{style:{display:"flex",flexDirection:"column"},children:[(0,o.jsx)("span",{style:{fontWeight:500,lineHeight:1.3},children:e.mainText}),e.romanizedText&&(0,o.jsx)("span",{style:{fontSize:"0.8em",opacity:.8,marginTop:"0.15rem",fontWeight:400,lineHeight:1.2},children:e.romanizedText})]}):(0,o.jsx)("div",{style:{display:"flex",flexDirection:"column"},children:(0,o.jsx)("span",{style:{fontWeight:500,lineHeight:1.3},children:"Correct!"})})})()]})}),(0,o.jsxs)("div",{style:{display:"flex",gap:"0.5rem",marginTop:"0.5rem"},children:[D&&!r.detailedFeedback&&(0,o.jsx)("button",{onClick:_,disabled:h[i],style:{padding:"0.3rem 0.8rem",borderRadius:6,border:"1px solid var(--rose-primary)",background:a?"rgba(232,179,195,0.15)":"rgba(132,84,109,0.1)",color:"var(--rose-primary)",fontSize:"0.8rem",cursor:h[i]?"not-allowed":"pointer",transition:"all 0.3s ease",opacity:h[i]?.6:1,minWidth:"80px",fontWeight:600,fontFamily:"Montserrat, Arial, sans-serif",marginTop:4,boxShadow:a?"0 2px 8px rgba(232,179,195,0.1)":"0 2px 8px rgba(132,84,109,0.08)",backdropFilter:"blur(10px)"},title:"Check for errors",children:h[i]?"\uD83D\uDD04":"\uD83C\uDFAF Check"}),!D&&(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("button",{onClick:()=>v(i,r.text),disabled:S[i],style:{padding:"0.35rem 0.9rem",borderRadius:6,border:"1px solid #4a90e2",background:"rgba(74,144,226,0.08)",color:"#4a90e2",fontSize:"0.8rem",cursor:S[i]?"not-allowed":"pointer",transition:"all 0.2s ease",opacity:S[i]?.6:1,minWidth:"70px",fontWeight:500,boxShadow:"0 1px 3px rgba(74,144,226,0.10)"},title:"Get translation and explanation",children:S[i]?"\uD83D\uDD04 Translating...":"\uD83C\uDF10 Translate"}),(0,o.jsx)("button",{onClick:j,disabled:x["message_".concat(i)]||b["message_".concat(i)],style:{padding:"0.3rem 0.7rem",borderRadius:8,border:b["message_".concat(i)]?"none":"1px solid var(--blue-secondary)",background:b["message_".concat(i)]?"linear-gradient(135deg, var(--blue-secondary) 0%, #2a4a6a 100%)":a?"rgba(139,163,217,0.15)":"rgba(59,83,119,0.1)",color:b["message_".concat(i)]?"#fff":"var(--blue-secondary)",fontSize:"0.7rem",cursor:x["message_".concat(i)]||b["message_".concat(i)]?"not-allowed":"pointer",transition:"all 0.3s ease",opacity:x["message_".concat(i)]||b["message_".concat(i)]?.6:1,minWidth:"80px",fontWeight:600,fontFamily:"Montserrat, Arial, sans-serif",boxShadow:b["message_".concat(i)]?"0 2px 6px rgba(59,83,119,0.18)":a?"0 2px 8px rgba(139,163,217,0.1)":"0 2px 8px rgba(59,83,119,0.08)",backdropFilter:"blur(10px)"},title:b["message_".concat(i)]?"Playing audio...":"Listen to this message",children:x["message_".concat(i)]?"\uD83D\uDD04 Generating...":b["message_".concat(i)]?"\uD83D\uDD0A Playing":"\uD83D\uDD0A Listen"}),(l||s)&&(0,o.jsx)("button",{onClick:w,disabled:E,style:{padding:"0.3rem 0.7rem",border:"1px solid var(--rose-primary)",background:a?"rgba(232,179,195,0.15)":"rgba(132,84,109,0.1)",color:"var(--rose-primary)",fontSize:"0.7rem",cursor:E?"not-allowed":"pointer",transition:"all 0.3s ease",opacity:E?.6:1,fontWeight:600,fontFamily:"Montserrat, Arial, sans-serif",borderRadius:8,minWidth:"80px",boxShadow:a?"0 2px 8px rgba(232,179,195,0.1)":"0 2px 8px rgba(132,84,109,0.08)",backdropFilter:"blur(10px)"},title:"Get conversation suggestions",children:E?"\uD83D\uDD04 Loading...":"\uD83D\uDCA1 Suggestions"})]})]})]})});q.displayName="ChatMessageItem";let K=e=>{let{isDarkMode:r,suggestionMessages:t,currentSuggestionIndex:n,onNavigateSuggestion:a,onExplainSuggestion:i,onPlaySuggestionTTS:s,isTranslatingSuggestion:l,showSuggestionTranslations:c,suggestionTranslations:g,isGeneratingTTS:u,isPlayingTTS:p,userPreferences:f,language:m}=e,h=t[n];return h?(0,o.jsx)("div",{style:{width:"100%",padding:"0.75rem 0.75rem 0.75rem 0.75rem",marginTop:"0.5rem"},children:(0,o.jsx)("div",{style:{width:"100%",display:"flex",flexDirection:"column",alignItems:"flex-end"},children:(0,o.jsxs)("div",{className:"hover-lift",style:{maxWidth:"70%",padding:"1rem 1.25rem",background:r?"linear-gradient(135deg, rgba(195,141,148,0.15) 0%, rgba(195,141,148,0.08) 100%)":"linear-gradient(135deg, rgba(195,141,148,0.12) 0%, rgba(195,141,148,0.06) 100%)",color:r?"var(--foreground)":"#3e3e3e",borderRadius:"28px 28px 8px 28px",border:r?"2px dashed rgba(195,141,148,0.5)":"2px dashed #c38d94",fontSize:"0.85rem",fontWeight:600,position:"relative",boxShadow:r?"0 8px 32px rgba(195,141,148,0.2), 0 2px 8px rgba(195,141,148,0.1)":"0 8px 32px rgba(195,141,148,0.25), 0 2px 8px rgba(195,141,148,0.15)",fontFamily:"AR One Sans, Arial, sans-serif",transition:"all 0.3s ease",backdropFilter:"blur(20px)"},children:[(0,o.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:"0.5rem",fontSize:"0.8rem",color:r?"#8ba3d9":"#3b5377"},children:[(0,o.jsxs)("span",{children:["\uD83D\uDCAD Suggestion (",n+1,"/",t.length,")"]}),(0,o.jsxs)("div",{style:{display:"flex",gap:"0.3rem"},children:[(0,o.jsx)(d.P.button,{onClick:()=>a("prev"),disabled:t.length<=1,whileHover:{scale:1.05},whileTap:{scale:.95},style:{padding:"0.3rem 0.5rem",borderRadius:6,border:"1px solid ".concat(r?"rgba(139,163,217,0.6)":"#3b5377"),background:r?"rgba(139,163,217,0.08)":"rgba(59,83,119,0.08)",color:r?"#8ba3d9":"#3b5377",cursor:t.length<=1?"not-allowed":"pointer",fontSize:"0.7rem",opacity:t.length<=1?.5:1,transition:"all 0.3s ease",fontWeight:600},children:"←"}),(0,o.jsx)(d.P.button,{onClick:()=>a("next"),disabled:t.length<=1,whileHover:{scale:1.05},whileTap:{scale:.95},style:{padding:"0.3rem 0.5rem",borderRadius:6,border:"1px solid ".concat(r?"rgba(139,163,217,0.6)":"#3b5377"),background:r?"rgba(139,163,217,0.08)":"rgba(59,83,119,0.08)",color:r?"#8ba3d9":"#3b5377",cursor:t.length<=1?"not-allowed":"pointer",fontSize:"0.7rem",opacity:t.length<=1?.5:1,transition:"all 0.3s ease",fontWeight:600},children:"→"})]})]}),(0,o.jsx)("div",{style:{lineHeight:"1.4",wordWrap:"break-word",marginBottom:"0.3rem"},children:(()=>{let e=_((null==h?void 0:h.text)||"",m);return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("span",{children:e.mainText}),e.romanizedText&&(0,o.jsx)("span",{style:{fontSize:"0.85em",color:"#555",opacity:.65,marginTop:2,fontWeight:400,lineHeight:"1.2",letterSpacing:"0.01em",display:"block"},children:e.romanizedText})]})})()}),(0,o.jsxs)("div",{style:{display:"flex",gap:"0.5rem",marginTop:"0.5rem",justifyContent:"flex-end"},children:[(0,o.jsx)("button",{onClick:()=>i(n,h.text),style:{padding:"0.35rem 0.9rem",borderRadius:6,border:"1px solid #4a90e2",background:"rgba(74,144,226,0.08)",color:"#4a90e2",fontSize:"0.8rem",cursor:l[n]?"not-allowed":"pointer",transition:"all 0.2s ease",opacity:l[n]?.6:1,minWidth:"70px",fontWeight:500,boxShadow:"0 1px 3px rgba(74,144,226,0.10)"},title:"Get translation",children:l[n]?"\uD83D\uDD04 Explaining...":"\uD83D\uDCA1 Explain"}),(0,o.jsx)("button",{onClick:()=>s(h,n),disabled:u["suggestion_".concat(n)]||p["suggestion_".concat(n)],style:{padding:"0.3rem 0.7rem",borderRadius:8,border:p["suggestion_".concat(n)]?"none":"1px solid var(--blue-secondary)",background:p["suggestion_".concat(n)]?"linear-gradient(135deg, var(--blue-secondary) 0%, #2a4a6a 100%)":r?"rgba(139,163,217,0.15)":"rgba(59,83,119,0.1)",color:p["suggestion_".concat(n)]?"#fff":"var(--blue-secondary)",fontSize:"0.7rem",cursor:u["suggestion_".concat(n)]||p["suggestion_".concat(n)]?"not-allowed":"pointer",transition:"all 0.3s ease",opacity:u["suggestion_".concat(n)]||p["suggestion_".concat(n)]?.6:1,minWidth:"80px",fontWeight:600,fontFamily:"Montserrat, Arial, sans-serif",boxShadow:p["suggestion_".concat(n)]?"0 2px 6px rgba(59,83,119,0.18)":r?"0 2px 8px rgba(139,163,217,0.1)":"0 2px 8px rgba(59,83,119,0.08)",backdropFilter:"blur(10px)"},title:p["suggestion_".concat(n)]?"Playing audio...":"Listen to this message",children:u["suggestion_".concat(n)]?"\uD83D\uDD04 Generating...":p["suggestion_".concat(n)]?"\uD83D\uDD0A Playing":"\uD83D\uDD0A Listen"})]}),c[n]&&g[n]&&(0,o.jsxs)("div",{style:{marginTop:"0.75rem",padding:"0.75rem",background:r?"rgba(255,255,255,0.05)":"rgba(0,0,0,0.03)",borderRadius:"8px",border:"1px solid rgba(74,144,226,0.2)"},children:[g[n].translation&&(0,o.jsxs)("div",{style:{marginBottom:"0.5rem"},children:[(0,o.jsx)("strong",{style:{color:r?"#8ba3d9":"#4a90e2"},children:"Translation:"}),(0,o.jsx)("div",{style:{marginTop:"0.25rem",fontSize:"0.9rem"},children:g[n].translation})]}),g[n].breakdown&&(0,o.jsxs)("div",{children:[(0,o.jsx)("strong",{style:{color:r?"#8ba3d9":"#4a90e2"},children:"Explanation:"}),(0,o.jsx)("div",{style:{marginTop:"0.25rem",fontSize:"0.85rem",lineHeight:"1.4",whiteSpace:"pre-wrap"},children:g[n].breakdown})]})]})]})})}):null},Y=e=>{let{chatHistory:r,isDarkMode:t,onMessageClick:a,onTranslateMessage:i,onRequestDetailedFeedback:s,onRequestShortFeedback:l,onRequestDetailedBreakdown:c,onToggleDetailedFeedback:d,onToggleShortFeedback:g,onQuickTranslation:u,onExplainLLMResponse:p,onPlayTTS:f,onPlayExistingTTS:m,translations:h,isTranslating:y,showTranslations:S,showDetailedBreakdown:x,showSuggestionExplanations:b,explainButtonPressed:v,parsedBreakdown:T,feedbackExplanations:w,activePopup:E,showCorrectedVersions:A,quickTranslations:k,showQuickTranslations:C,ttsCache:I,isGeneratingTTS:D,isPlayingTTS:R,isLoadingMessageFeedback:j,isLoadingExplain:_,romanizationDisplay:N,language:O,messageCount:P,hasMoreMessages:F,isLoadingMoreMessages:B,loadMoreMessages:z,userPreferences:U,handleSuggestionButtonClick:M,isLoadingSuggestions:L,showSuggestionCarousel:G,suggestionMessages:W,currentSuggestionIndex:H,onNavigateSuggestion:V,onExplainSuggestion:Y,onPlaySuggestionTTS:J,isTranslatingSuggestion:X,showSuggestionTranslations:$,suggestionTranslations:Q}=e,Z=(0,n.useRef)(null),[ee,er]=(0,n.useState)([]),[et,eo]=(0,n.useState)(0);return(0,n.useEffect)(()=>{let e=Z.current;if(!e)return;let t=()=>{let t=e.scrollTop,o=e.clientHeight,n=[],a=0;if(r.some(e=>e.isFromOriginalConversation)&&r.length>0){let e=Math.max(0,r.length-15);for(let i=0;i<r.length;i++){let r=a,s=a+200;(i>=e||s>t-2*o&&r<t+3*o)&&n.push({index:i,start:a}),a+=200}}else for(let e=0;e<r.length;e++){let r=a;a+200>t-o&&r<t+2*o&&n.push({index:e,start:a}),a+=200}let i=Math.max(a,o);er(n),eo(i)};return t(),e.addEventListener("scroll",t,{passive:!0}),()=>e.removeEventListener("scroll",t)},[r]),(0,n.useEffect)(()=>{let e=Z.current;e&&(e.style.paddingBottom="144px")},[]),(0,o.jsx)("div",{ref:Z,className:"chat-messages-container",onScroll:e=>{0===e.target.scrollTop&&F&&!B&&z()},style:{padding:"1.5rem",overflowY:"auto",flex:1,display:"flex",flexDirection:"column",gap:"1rem",minHeight:0,maxHeight:"calc(100vh - 280px)"},children:(0,o.jsxs)("div",{style:{height:"".concat(et,"px"),position:"relative"},children:[B&&(0,o.jsx)("div",{style:{position:"absolute",top:"0",left:"0",width:"100%",padding:"1rem",textAlign:"center",background:t?"rgba(30,41,59,0.8)":"rgba(255,255,255,0.8)",borderRadius:"8px",marginBottom:"1rem",zIndex:10},children:"⏳ Loading more messages..."}),F&&P>r.length&&(0,o.jsxs)("div",{style:{position:"absolute",top:B?"60px":"0",left:"0",width:"100%",padding:"0.5rem",textAlign:"center",fontSize:"0.8rem",color:t?"#94a3b8":"#6b7280",background:t?"rgba(30,41,59,0.6)":"rgba(255,255,255,0.6)",borderRadius:"6px",marginBottom:"0.5rem",zIndex:5},children:["Showing ",r.length," of ",P," messages • Scroll up to load more"]}),(()=>{let e=(()=>{for(let t=r.length-1;t>=0;t--){var e;if((null==(e=r[t])?void 0:e.sender)==="AI")return t}return -1})();return ee.map(n=>{let{index:a,start:i}=n,s=r[a];if(!s)return null;let l=a===e,c=a===r.length-1,h=((e,r,t)=>e?{mainText:e.text||"",romanizedText:e.romanizedText||""}:{mainText:"",romanizedText:""})(s,0,0);return(0,o.jsxs)("div",{style:{position:"absolute",top:0,left:0,right:0,transform:"translateY(".concat(i,"px)"),height:200,padding:"0 0.5rem"},children:[(0,o.jsx)(q,{message:s,formatted:h,index:a,isDarkMode:t,isLastAIMessage:l,isLastMessage:c,toggleShortFeedback:g,toggleDetailedFeedback:d,generateTTSForText:(e,r,t)=>f(e,r),language:O,userPreferences:{romanizationDisplay:N},playTTS:f,getTTSText:(e,r)=>"original"===r||"both"===r?e.text:e.romanizedText||e.text,isLoadingMessageFeedback:j,isTranslating:y,isGeneratingTTS:D,isPlayingTTS:R,quickTranslation:u,onExplainLLMResponse:p,isLoadingExplain:_,handleSuggestionButtonClick:M,isLoadingSuggestions:L,playExistingTTS:m,showCorrectedVersions:A,extractCorrectedVersion:()=>null,renderFormattedText:()=>null}),l&&G&&W.length>0&&(0,o.jsx)("div",{style:{position:"relative",padding:"0.75rem 0.75rem 0.75rem 0.75rem",marginTop:"0.5rem",width:"100%"},children:(0,o.jsx)(K,{isDarkMode:t,suggestionMessages:W,currentSuggestionIndex:H,onNavigateSuggestion:V,onExplainSuggestion:Y,onPlaySuggestionTTS:J,isTranslatingSuggestion:X,showSuggestionTranslations:$,suggestionTranslations:Q,isGeneratingTTS:D,isPlayingTTS:R,userPreferences:U,language:O})})]},s.id||a)})})()]})})},J=e=>{let{isOpen:r,onClose:t,progressData:n}=e,a=(0,l.useRouter)();return r&&n?(0,o.jsx)("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:(0,o.jsxs)("div",{style:{backgroundColor:"var(--background)",borderRadius:"12px",padding:"2rem",maxWidth:"500px",width:"90%",maxHeight:"80vh",overflowY:"auto",boxShadow:"0 20px 40px rgba(0, 0, 0, 0.3)"},children:[n.levelUpEvents&&n.levelUpEvents.length>0?(0,o.jsxs)("div",{style:{textAlign:"center",marginBottom:"1.5rem"},children:[(0,o.jsx)("div",{style:{fontSize:"1.5rem",marginBottom:"0.3rem"},children:"\uD83C\uDF89"}),(0,o.jsx)("div",{style:{color:"var(--foreground)",fontSize:"1rem",fontWeight:700,marginBottom:"0.3rem",fontFamily:"Gabriela, Arial, sans-serif"},children:"Congratulations! You've Leveled Up!"}),(0,o.jsx)("div",{style:{color:"var(--muted-foreground)",fontSize:"0.8rem",fontFamily:"AR One Sans, Arial, sans-serif"},children:"Your hard work paid off! Here's what you achieved:"})]}):(0,o.jsxs)("div",{style:{textAlign:"center",marginBottom:"1.5rem"},children:[(0,o.jsx)("div",{style:{fontSize:"2rem",marginBottom:"0.4rem"},children:"\uD83D\uDCCA"}),(0,o.jsx)("div",{style:{color:"var(--foreground)",fontSize:"1.1rem",fontWeight:700,marginBottom:"0.4rem",fontFamily:"Gabriela, Arial, sans-serif"},children:"Keep Practicing!"}),(0,o.jsx)("div",{style:{color:"var(--muted-foreground)",fontSize:"0.85rem",fontFamily:"AR One Sans, Arial, sans-serif"},children:"Here's your current progress on your learning goals:"})]}),(0,o.jsx)("div",{style:{marginBottom:"1.5rem",padding:"0.75rem",background:"linear-gradient(135deg, rgba(126,90,117,0.1) 0%, rgba(126,90,117,0.05) 100%)",borderRadius:"12px",border:"1px solid rgba(126,90,117,0.2)"},children:(0,o.jsx)("div",{style:{display:"flex",flexDirection:"column",gap:"0.5rem"},children:n.percentages.map((e,r)=>{var t;let a=null==(t=n.levelUpEvents)?void 0:t.find(e=>{var t;return e.subgoalId===(null==(t=n.subgoalIds)?void 0:t[r])});return(0,o.jsxs)("div",{style:{background:"var(--card)",borderRadius:"8px",padding:"0.5rem",border:a?"1px solid rgba(126,90,117,0.3)":"1px solid rgba(126,90,117,0.15)",position:"relative",...a&&{background:"linear-gradient(135deg, rgba(126,90,117,0.05) 0%, rgba(126,90,117,0.02) 100%)",border:"1px solid rgba(126,90,117,0.3)"}},children:[(0,o.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"0.4rem",marginBottom:"0.5rem"},children:[(0,o.jsx)("div",{style:{background:a?"var(--rose-primary)":"var(--rose-accent)",color:"#fff",borderRadius:"50%",width:"24px",height:"24px",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"0.8rem",fontWeight:600,fontFamily:"Montserrat, Arial, sans-serif"},children:r+1}),(0,o.jsx)("div",{style:{color:"var(--foreground)",fontWeight:600,fontSize:"0.8rem",fontFamily:"Gabriela, Arial, sans-serif"},children:n.subgoalNames[r]||"Goal ".concat(r+1)}),a&&(0,o.jsx)("div",{style:{background:"var(--rose-primary)",color:"#fff",borderRadius:"12px",padding:"0.2rem 0.5rem",fontSize:"0.7rem",fontWeight:600,fontFamily:"Montserrat, Arial, sans-serif",marginLeft:"auto"},children:"LEVEL UP!"})]}),(0,o.jsxs)("div",{style:{marginBottom:"0.5rem"},children:[(0,o.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"0.3rem"},children:[(0,o.jsx)("div",{style:{color:"var(--muted-foreground)",fontSize:"0.75rem",fontFamily:"Montserrat, Arial, sans-serif"},children:a?"Level ".concat(a.oldLevel+1," → Level ").concat(a.newLevel+1):"Current Progress"}),(0,o.jsx)("div",{style:{color:"var(--rose-primary)",fontSize:"0.75rem",fontWeight:600,fontFamily:"Montserrat, Arial, sans-serif"},children:a?"100%":Math.round(e)+"%"})]}),(0,o.jsx)("div",{style:{width:"100%",height:"6px",background:"rgba(126,90,117,0.1)",borderRadius:"3px",overflow:"hidden",position:"relative"},children:(0,o.jsx)("div",{style:{width:"".concat(e,"%"),height:"100%",background:"linear-gradient(90deg, var(--rose-primary) 0%, #8a6a7a 100%)",borderRadius:"4px",transition:"width 0.8s ease-in-out"}})})]}),a&&(0,o.jsxs)("div",{style:{background:"rgba(126,90,117,0.05)",borderRadius:"6px",padding:"0.4rem",border:"1px solid rgba(126,90,117,0.1)"},children:[(0,o.jsx)("div",{style:{color:"var(--muted-foreground)",fontSize:"0.7rem",fontWeight:600,marginBottom:"0.3rem",fontFamily:"Montserrat, Arial, sans-serif"},children:"New Challenge:"}),(0,o.jsx)("div",{style:{color:"var(--foreground)",fontSize:"0.75rem",lineHeight:"1.2",fontFamily:"AR One Sans, Arial, sans-serif"},children:a.newDescription})]})]},r)})})}),n.levelUpEvents&&n.levelUpEvents.length>0&&(0,o.jsxs)("div",{style:{marginBottom:"1.5rem"},children:[(0,o.jsx)("h3",{style:{color:"var(--foreground)",fontSize:"1.1rem",fontWeight:600,marginBottom:"1rem",textAlign:"center",fontFamily:"Montserrat, Arial, sans-serif"},children:"\uD83D\uDE80 Level Up!"}),n.levelUpEvents.map((e,r)=>(0,o.jsxs)("div",{style:{backgroundColor:"var(--muted)",borderRadius:"8px",padding:"1rem",marginBottom:"0.5rem",border:"1px solid rgba(126,90,117,0.1)"},children:[(0,o.jsx)("div",{style:{color:"var(--muted-foreground)",fontSize:"0.7rem",fontWeight:600,marginBottom:"0.3rem",fontFamily:"Montserrat, Arial, sans-serif"},children:"New Challenge:"}),(0,o.jsx)("div",{style:{color:"var(--foreground)",fontSize:"0.75rem",lineHeight:"1.2",fontFamily:"AR One Sans, Arial, sans-serif"},children:e.newDescription})]},r))]}),(0,o.jsx)("div",{style:{display:"flex",justifyContent:"center"},children:(0,o.jsx)("button",{onClick:()=>{t(),a.push("/dashboard")},style:{padding:"0.6rem 1.5rem",border:"none",borderRadius:"8px",background:"var(--rose-primary)",color:"#ffffff",cursor:"pointer",fontSize:"0.9rem",fontWeight:600,fontFamily:"Montserrat, Arial, sans-serif",transition:"all 0.2s ease",boxShadow:"0 2px 4px rgba(0, 0, 0, 0.1)"},onMouseEnter:e=>{e.currentTarget.style.background="linear-gradient(135deg, var(--rose-primary) 0%, #8a6a7a 100%)"},onMouseLeave:e=>{e.currentTarget.style.background="var(--rose-primary)"},children:"Continue to Dashboard"})})]})}):null},X=e=>{let{activePopup:r,quickTranslations:t,feedbackExplanations:n,isDarkMode:a}=e;return r?(0,o.jsxs)("div",{"data-popup":"true",style:{position:"fixed",left:Math.max(10,Math.min(window.innerWidth-320,r.position.x)),top:Math.max(10,r.position.y-60),transform:"translateX(-50%)",backgroundColor:a?"#1e293b":"#ffffff",border:"1px solid ".concat(a?"#475569":"#e2e8f0"),borderRadius:"8px",padding:"12px 16px",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.15)",zIndex:1e3,maxWidth:"300px",fontSize:"14px",lineHeight:"1.4",color:a?"#e2e8f0":"#1e293b",pointerEvents:"auto"},onClick:e=>e.stopPropagation(),children:[(0,o.jsx)("div",{style:{fontWeight:400,marginBottom:"4px",color:a?"#cbd5e1":"#475569",fontSize:"13px"},children:r.wordKey.replace(/[__~~==<<>>]/g,"")}),(0,o.jsx)("div",{style:{fontSize:"14px",fontWeight:600,color:a?"#f1f5f9":"#0f172a"},children:(()=>{var e,o,a,i;let s=null==(e=t[r.messageIndex])?void 0:e.wordTranslations[r.wordKey];return console.log("Popup translation lookup:",{messageIndex:r.messageIndex,wordKey:r.wordKey,translation:s,allTranslations:null==(o=t[r.messageIndex])?void 0:o.wordTranslations,availableKeys:Object.keys((null==(a=t[r.messageIndex])?void 0:a.wordTranslations)||{})}),s||(null==(i=n[r.messageIndex])?void 0:i[r.wordKey])||"No translation available"})()}),(0,o.jsx)("div",{style:{position:"absolute",bottom:"-6px",left:"50%",transform:"translateX(-50%)",width:0,height:0,borderLeft:"6px solid transparent",borderRight:"6px solid transparent",borderTop:"6px solid ".concat(a?"#1e293b":"#ffffff"),filter:"drop-shadow(0 1px 1px ".concat(a?"rgba(0,0,0,0.3)":"rgba(0,0,0,0.1)",")")}})]}):null},$=async()=>{let e=localStorage.getItem("jwt");if(e)return{Authorization:"Bearer ".concat(e)};try{let e=await (0,p.p9)();if(e)return localStorage.setItem("jwt",e),{Authorization:"Bearer ".concat(e)}}catch(e){console.error("Failed to get Firebase token:",e)}return{}},Q=async(e,r)=>{try{if(!r)return null;let{success:t,data:o}=await (0,u.p5)(r);if(!t)return console.error("Failed to fetch language dashboards"),null;let n=(o||[]).find(r=>r.language===e);if(n)return{formality:n.formality||"friendly",topics:n.talk_topics||[],user_goals:n.learning_goals||[],userLevel:n.proficiency_level||"beginner",feedbackLanguage:n.feedback_language||"en",romanization_display:n.romanization_display||"both",proficiency_level:n.proficiency_level||"beginner",talk_topics:n.talk_topics||[],learning_goals:n.learning_goals||[],speak_speed:n.speak_speed||1};return null}catch(e){return console.error("Error fetching user dashboard preferences:",e),null}},Z=async function(e,r,t,o,n,a){let i=arguments.length>6&&void 0!==arguments[6]&&arguments[6],l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;if(!a)return null;try{let a=await $(),c=(await s.A.post("/api/conversations",{language:n,title:r||"New Conversation",topics:t,formality:o,usesPersona:i,personaId:l},{headers:a})).data.conversation.id;for(let r=0;r<e.length;r++){let t=e[r],o=await $();await s.A.post("/api/conversations/".concat(c,"/messages"),{sender:t.sender,text:t.text,messageType:"text",message_order:r+1},{headers:o})}let d=new URL(window.location.href);return d.searchParams.set("conversation",c),window.history.replaceState({},"",d.toString()),c}catch(e){console.error("Error saving session to backend:",e)}return null},ee=async e=>{try{console.log("[CONVERSATION_SERVICE] Loading conversation:",{conversationId:e,conversationIdType:typeof e,conversationIdLength:e.length,conversationIdTruthy:!!e});let t=await $(),o="/api/conversations/".concat(e);console.log("[CONVERSATION_SERVICE] Request URL:",o),console.log("[CONVERSATION_SERVICE] Headers:",t);let n=await s.A.get(o,{headers:t});if(console.log("[CONVERSATION_SERVICE] Response status:",n.status),console.log("[CONVERSATION_SERVICE] Response data:",n.data),!n.data.conversation)return console.warn("[CONVERSATION_SERVICE] No conversation data in response"),null;{var r;let t=n.data.conversation;console.log("[CONVERSATION_SERVICE] Raw conversation data:",{id:t.id,title:t.title,uses_persona:t.uses_persona,persona_id:t.persona_id,description:t.description});let o=(t.messages||[]).map(e=>({sender:e.sender,text:e.text,romanizedText:e.romanized_text||"",timestamp:new Date(e.created_at||e.timestamp),isFromOriginalConversation:!0,messageType:e.message_type||"text",audioFilePath:e.audio_file_path,detailedFeedback:e.detailed_feedback}));return console.log("[CONVERSATION_SERVICE] Parsed messages:",o.length),{messages:o,conversationId:e,description:t.description||"",language:t.language||(null==(r=t.language_dashboards)?void 0:r.language),formality:t.formality,topics:t.topics||[],learningGoals:t.learning_goals||[],selectedSubgoals:t.selected_subgoals||[],createdAt:t.created_at||t.createdAt,usesPersona:!0===t.uses_persona||"true"===t.uses_persona,personaId:t.persona_id||null}}}catch(e){return console.error("[CONVERSATION_SERVICE] Error loading conversation:",e),e.response&&console.error("[CONVERSATION_SERVICE] Error response:",e.response.status,e.response.data),null}},er=async(e,r,t)=>{if(r)try{let o=await $(),n=t||Date.now();await s.A.post("/api/conversations/".concat(r,"/messages"),{sender:e.sender,text:e.text,messageType:"text",message_order:n},{headers:o})}catch(e){console.error("Error saving message to backend:",e)}},et=async(e,r,t,o,n)=>{if(console.log("\uD83D\uDD0D [CONVERSATION_SERVICE] generateConversationSummary function called!"),n)try{console.log("\uD83D\uDD0D [CONVERSATION_SERVICE] About to call getAuthHeaders()");let o=await $();console.log("\uD83D\uDD0D [CONVERSATION_SERVICE] getAuthHeaders() completed successfully");let a="";try{let e=await (0,u.p5)("current"),t=null==e?void 0:e.success,o=null==e?void 0:e.data,n=t?(o||[]).find(e=>e.language===r):null,i=(null==n?void 0:n.learning_goals)||(null==n?void 0:n.learningGoals)||[];if(i.length>0){let e=[];i.forEach(r=>{let t=g.Kq.find(e=>e.id===r);(null==t?void 0:t.subgoals)&&t.subgoals.forEach((r,t)=>{e.push("".concat(t+1,": ").concat(r.description))})}),a=e.join("\n")}}catch(e){console.warn("[CONVERSATION_SERVICE] Failed to fetch user learning goals:",e)}let i=await s.A.post("/api/conversation-summary",{chat_history:e,subgoal_instructions:a,user_topics:t,target_language:r,feedback_language:"en",is_continued_conversation:!1,conversation_id:n},{headers:o});if(!i.data.success)return null;{let e={title:i.data.title,synopsis:i.data.synopsis,learningGoals:i.data.progress_percentages||[]},t=[],a=[];try{let e=await (0,u.p5)("current"),o=null==e?void 0:e.success,n=null==e?void 0:e.data,i=o?(n||[]).find(e=>e.language===r):null;((null==i?void 0:i.learning_goals)||(null==i?void 0:i.learningGoals)||[]).forEach(e=>{let r=g.Kq.find(r=>r.id===e);(null==r?void 0:r.subgoals)&&r.subgoals.forEach(e=>{t.push(e.id),a.push(r.goal)})})}catch(e){console.warn("[CONVERSATION_SERVICE] Failed to fetch user dashboard for learning goals:",e)}let l={subgoalIds:t,subgoalNames:a,percentages:e.learningGoals};try{await s.A.put("/api/conversations/".concat(n,"/title"),{title:e.title,synopsis:e.synopsis,progress_data:l},{headers:o})}catch(e){console.warn("[CONVERSATION_SERVICE] Failed to update conversation:",e)}return{title:e.title,synopsis:e.synopsis,learningGoals:e.learningGoals,subgoalIds:t,subgoalNames:a}}}catch(e){var a;return console.error("\uD83D\uDD0D [CONVERSATION_SERVICE] Error generating conversation summary:",e),console.error("\uD83D\uDD0D [CONVERSATION_SERVICE] Error details:",(null==(a=e.response)?void 0:a.data)||e.message),null}},eo={autospeak:1e4},en=e=>{if(!e.startsWith("/files/"))return e;let r=window.location.origin;return"".concat(r).concat(e)},ea=async e=>{try{let r=en(e);return(await fetch(r,{method:"HEAD"})).ok}catch(e){return console.warn("TTS URL accessibility check failed:",e),!1}},ei=async(e,r,t)=>{try{let e=localStorage.getItem("jwt");return(await s.A.post("/api/short_feedback",{transcription:r,language:t},{headers:{"Content-Type":"application/json",...e?{Authorization:"Bearer ".concat(e)}:{}}})).data}catch(e){throw console.error("Error getting short feedback:",e),e}},es=async(e,r,t)=>{try{let e=localStorage.getItem("jwt");return(await s.A.post("/api/detailed_breakdown",{message:r,language:t},{headers:{"Content-Type":"application/json",...e?{Authorization:"Bearer ".concat(e)}:{}}})).data}catch(e){throw console.error("Error getting detailed breakdown:",e),e}},el=async(e,r,t)=>{try{let e=localStorage.getItem("jwt");return(await s.A.post("/api/quick_translation",{ai_message:r,chat_history:[],language:t,user_level:"beginner",user_topics:[],formality:"friendly",feedback_language:"en",user_goals:[],description:null},{headers:{"Content-Type":"application/json",...e?{Authorization:"Bearer ".concat(e)}:{}}})).data}catch(e){throw console.error("Error getting quick translation:",e),e}},ec=async(e,r,t)=>{try{let e=localStorage.getItem("jwt");return(await s.A.post("/api/explain_suggestion",{suggestion:r,language:t},{headers:{"Content-Type":"application/json",...e?{Authorization:"Bearer ".concat(e)}:{}}})).data}catch(e){throw console.error("Error explaining LLM response:",e),e}},ed=(e,r,t,n)=>(console.log("=== RENDERING FROM GENERATED WORDS ==="),console.log("Generated words:",e),console.log("Available translations:",Object.keys(r.wordTranslations)),e.map((e,a)=>{let i=e.trim(),s=r.wordTranslations[i]||r.wordTranslations[i.replace(/[.,!?;:'"()\[\]{}]/g,"").trim()];return(console.log('Generated word "'.concat(i,'": hasTranslation=').concat(s)),s&&i)?(0,o.jsx)("span",{"data-clickable-word":"true",onClick:e=>{if(e.stopPropagation(),e.preventDefault(),console.log("Word clicked:",i,"Translation:",s),n){let r=e.currentTarget.getBoundingClientRect(),o={x:r.left+r.width/2,y:r.top};console.log("Setting popup with:",{messageIndex:t,wordKey:i,position:o}),n({messageIndex:t,wordKey:i,position:o})}},style:{cursor:"pointer",textDecoration:"underline",textDecorationColor:"#4a90e2",textDecorationThickness:"2px",color:"#4a90e2",fontWeight:400,transition:"all 0.2s ease",marginRight:"0.25rem",whiteSpace:"nowrap",display:"inline-block"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor="rgba(74,144,226,0.1)"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="transparent"},children:e},a):(0,o.jsx)("span",{style:{marginRight:"0.25rem",whiteSpace:"nowrap",display:"inline-block"},children:e},a)})),eg=(e,r,t,n)=>{console.log("=== RENDERING CLICKABLE WORDS ==="),console.log("Text to render:",e),console.log("Available translations:",Object.keys(r.wordTranslations));let a=e.split(/(\s+)/);return console.log("Split words:",a),a.map((e,a)=>{let i=e.trim(),s=r.wordTranslations[i],l=i;if(console.log('Checking word "'.concat(i,'": exact match = ').concat(s)),!s){let e=i.toLowerCase(),t=Object.keys(r.wordTranslations).find(r=>r.toLowerCase()===e);t&&(s=r.wordTranslations[t],l=t,console.log('Found case-insensitive match: "'.concat(i,'" → "').concat(t,'"')))}if(!s&&i){let e=Object.keys(r.wordTranslations).filter(e=>e.includes(i)||i.includes(e));e.length>0&&console.log('Partial matches for "'.concat(i,'":'),e)}return(console.log('Final result for "'.concat(i,'": hasTranslation=').concat(s,', translationKey="').concat(l,'"')),s&&i)?(0,o.jsx)("span",{"data-clickable-word":"true",onClick:e=>{if(e.stopPropagation(),e.preventDefault(),console.log("Word clicked:",i,"Translation:",s),n){let r=e.currentTarget.getBoundingClientRect(),o={x:r.left+r.width/2,y:r.top};n({messageIndex:t,wordKey:l,position:o})}},style:{cursor:"pointer",textDecoration:"underline",textDecorationColor:"#4a90e2",textDecorationThickness:"2px",color:"#4a90e2",fontWeight:400,transition:"all 0.2s ease"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor="rgba(74,144,226,0.1)"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="transparent"},children:e},a):e})},eu=(e,r)=>"both"===r&&e.romanizedText?"".concat(e.romanizedText," (").concat(e.text,")"):"romanized"===r&&e.romanizedText?e.romanizedText:e.text,ep="force-dynamic",ef=()=>{let e=(0,l.useRouter)(),{isDarkMode:r}=(0,i.D)(),t=(0,a.J)(),[c,d]=(0,n.useState)({conversationId:"",lang:"",topics:"",formality:"",usePersona:!1});n.useEffect(()=>{{let e=new URLSearchParams(window.location.search);d({conversationId:e.get("conversation")||"",lang:e.get("language")||"",topics:e.get("topics")||"",formality:e.get("formality")||"",usePersona:"true"===e.get("usePersona")})}},[]);let u=c.conversationId;c.lang;let p=c.topics;c.formality;let f=c.usePersona,[y,S]=(0,n.useState)("en"),[x,b]=(0,n.useState)(!1),[v,T]=(0,n.useState)(!1),[w,E]=(0,n.useState)(!1),[A,k]=(0,n.useState)(!0),[C,D]=(0,n.useState)(null),[R,j]=(0,n.useState)(""),[_,N]=(0,n.useState)(null),[O,P]=(0,n.useState)(!1),[F,B]=(0,n.useState)(!1),[G,H]=(0,n.useState)(null),[q,K]=(0,n.useState)(!1),[ep,ef]=(0,n.useState)(!1),[em,eh]=(0,n.useState)(!1),[ey,eS]=(0,n.useState)(!1),[ex,eb]=(0,n.useState)(null),[ev,eT]=(0,n.useState)(!1),[ew,eE]=(0,n.useState)(!1),[eA,ek]=(0,n.useState)(null),[eC,eI]=(0,n.useState)(null),[eD,eR]=(0,n.useState)({}),[ej,e_]=(0,n.useState)({}),[eN,eO]=(0,n.useState)({}),[eP,eF]=(0,n.useState)(!0),[eB,ez]=(0,n.useState)(.2),eU=(0,n.useMemo)(()=>{if(1===[eP,!0].filter(Boolean).length)return{left:0,center:1,right:0};{let e=Math.min(eB,1/3);return{left:e,center:1-e,right:0}}},[eP,eB]),[eM,eL]=(0,n.useState)(""),[eG,eW]=(0,n.useState)({}),[eH,eV]=(0,n.useState)(!0),[eq,eK]=(0,n.useState)(""),[eY,eJ]=(0,n.useState)(!1),[eX,e$]=(0,n.useState)(!1),[eQ,eZ]=(0,n.useState)(!1),[e0,e1]=(0,n.useState)(!1),[e5,e2]=(0,n.useState)(!1),[e3,e8]=(0,n.useState)(null),[e6,e4]=(0,n.useState)({}),[e9,e7]=(0,n.useState)({}),[re,rr]=(0,n.useState)(""),[rt,ro]=(0,n.useState)(new Map),[rn,ra]=(0,n.useState)(""),[ri,rs]=(0,n.useState)(""),[rl,rc]=(0,n.useState)(!1),[rd,rg]=(0,n.useState)(!1),[ru,rp]=(0,n.useState)(!1),[rf,rm]=(0,n.useState)(null),[rh,ry]=(0,n.useState)({}),[rS,rx]=(0,n.useState)([]),[rb,rv]=(0,n.useState)({}),[rT,rw]=(0,n.useState)([]),[rE,rA]=(0,n.useState)(null),[rk,rC]=(0,n.useState)(null),[rI,rD]=(0,n.useState)(0),[rR,rj]=(0,n.useState)(!1),[r_,rN]=(0,n.useState)(!1),rO=(0,n.useRef)(null);(0,n.useRef)(null),(0,n.useRef)(!1),(0,n.useRef)(null),(0,n.useRef)([]),(0,n.useRef)(!1);let rP=(0,n.useRef)(null);(0,n.useRef)(null),(0,n.useRef)(null),(0,n.useRef)(null);let[rF,rB]=function(e){let[r,t]=(0,n.useState)(()=>{try{let e=localStorage.getItem("chatHistory");if(e)return JSON.parse(e).map(e=>({...e,timestamp:new Date(e.timestamp)}))}catch(e){console.error("Error loading chat history from localStorage:",e)}return[]});return(0,n.useEffect)(()=>{e?localStorage.removeItem("chatHistory"):localStorage.setItem("chatHistory",JSON.stringify(r))},[r,e]),[r,t]}(t);!function(){let[e,r]=(0,n.useState)(!1),[t,o]=(0,n.useState)(!1),[a,i]=(0,n.useState)(null),[s,l]=(0,n.useState)(!1),[c,d]=(0,n.useState)(!1),g=(0,n.useRef)(null),u=(0,n.useRef)([]),p=(0,n.useRef)(!1),f=(0,n.useRef)(null),m=(0,n.useRef)(!1),h=(0,n.useRef)(null),y=(0,n.useRef)(null);n.useEffect(()=>{h.current=window.MediaRecorder||window.webkitMediaRecorder,y.current=window.SpeechRecognition||window.webkitSpeechRecognition},[]),(0,n.useCallback)(async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"en-US",t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(l(!1),m.current=t,!h.current)return alert("MediaRecorder API not supported in this browser."),!1;if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return alert("Microphone access is not available in this browser. Please use a modern browser with microphone support."),!1;try{let o=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:44100,channelCount:1}});i(o),u.current=[];let n=MediaRecorder.isTypeSupported("audio/webm;codecs=opus")?"audio/webm;codecs=opus":MediaRecorder.isTypeSupported("audio/webm")?"audio/webm":"audio/wav",a=new h.current(o,{mimeType:n});if(g.current=a,a.ondataavailable=e=>{e.data.size>0&&u.current.push(e.data)},a.onstop=()=>{if(p.current){p.current=!1,l(!0),o.getTracks().forEach(e=>e.stop()),i(null),r(!1),d(!1);return}new Blob(u.current,{type:n}),o.getTracks().forEach(e=>e.stop()),i(null),r(!1),d(!1)},a.start(100),r(!0),t){if(!y.current)return alert("SpeechRecognition API not supported in this browser."),!1;let o=new y.current;f.current=o,o.lang=e||"en-US",o.interimResults=!1,o.continuous=!1,t&&(o.maxAlternatives=1,setTimeout(()=>{f.current&&(console.log("[DEBUG] Autospeak: Speech recognition timeout reached, stopping recording"),f.current.stop())},1e4)),o.onresult=e=>{r(!1),g.current&&"inactive"!==g.current.state&&g.current.stop()},o.onerror=e=>{r(!1),g.current&&"inactive"!==g.current.state&&g.current.stop(),alert("Speech recognition error: "+e.error)},o.onend=()=>{r(!1),g.current&&"inactive"!==g.current.state&&g.current.stop()},o.start(),d(!1)}else d(!0);return!0}catch(t){console.error("Audio recording error:",t);let e="Could not start audio recording: "+t.message;return"NotAllowedError"===t.name?e="Microphone access denied. Please allow microphone permissions and try again.":"NotFoundError"===t.name?e="No microphone found. Please connect a microphone and try again.":"NotSupportedError"===t.name?e="Audio recording is not supported in this browser. Please use a modern browser.":"SecurityError"===t.name&&(e="Microphone access blocked for security reasons. Please check your browser settings."),alert(e),r(!1),d(!1),i(null),!1}},[]),(0,n.useCallback)(function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];e&&(p.current=!0),f.current&&(f.current.stop(),r(!1)),g.current&&"inactive"!==g.current.state&&g.current.stop(),a&&(a.getTracks().forEach(e=>e.stop()),i(null)),c&&d(!1)},[a,c]),(0,n.useCallback)(()=>{g.current&&e&&!t&&(g.current.pause(),o(!0))},[e,t]),(0,n.useCallback)(()=>{g.current&&e&&t&&(g.current.resume(),o(!1))},[e,t]),(0,n.useCallback)(()=>0===u.current.length?null:new Blob(u.current,{type:"audio/webm"}),[]),(0,n.useCallback)(()=>{u.current=[],l(!1),p.current=!1},[])}(),function(){let[e,r]=(0,n.useState)(!1),[t,o]=(0,n.useState)(null),[a,i]=(0,n.useState)([]),[l,c]=(0,n.useState)(!1),[d,g]=(0,n.useState)(!1),[u,p]=(0,n.useState)({}),[f,m]=(0,n.useState)({}),h=(0,n.useRef)(null);(0,n.useRef)(!1);let y=(0,n.useRef)(new Map),S=(0,n.useCallback)(async function(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:6,t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:300;for(let o=0;o<r;o++){try{if((await fetch(e,{method:"HEAD"})).ok)return!0}catch(e){console.log("\uD83C\uDFB5 [WAIT_FOR_URL] Attempt ".concat(o+1," failed:"),e)}o<r-1&&await new Promise(e=>setTimeout(e,t))}return!1},[]),x=((0,n.useCallback)(async(e,r,t)=>{try{console.log("\uD83C\uDFB5 [GENERATE_TTS] Starting TTS generation for:",e.substring(0,50)),p(e=>({...e,[t]:!0}));let o=localStorage.getItem("jwt"),n=await s.A.post("/api/tts",{text:e,language:r,cacheKey:t},{headers:{"Content-Type":"application/json",...o?{Authorization:"Bearer ".concat(o)}:{}}});if(n.data.ttsUrl)return console.log("\uD83C\uDFB5 [GENERATE_TTS] TTS URL generated:",n.data.ttsUrl),n.data.ttsUrl;return console.error("\uD83C\uDFB5 [GENERATE_TTS] No TTS URL in response"),null}catch(e){return console.error("\uD83C\uDFB5 [GENERATE_TTS] Error generating TTS:",e),null}finally{p(e=>({...e,[t]:!1}))}},[]),(0,n.useCallback)(async(e,t,n)=>{console.log("\uD83C\uDFB5 [USE_TTS] Called with:",{text:e,language:t,cacheKey:n}),z&&(console.log("\uD83C\uDFB5 [USE_TTS] TTS already playing globally, stopping current TTS first"),U()),h.current&&(console.log("\uD83C\uDFB5 [USE_TTS] Stopping current audio in hook"),h.current.pause(),h.current=null),console.log("\uD83C\uDFB5 [USE_TTS] Setting playing state"),m(e=>({...e,[n]:!0})),g(!0),r(!0),o(e);try{console.log("\uD83C\uDFB5 [USE_TTS] Using global TTS manager"),await M(e,t,n),console.log("\uD83C\uDFB5 [USE_TTS] Global TTS finished playing"),m(e=>({...e,[n]:!1})),g(!1),r(!1),o(null)}catch(e){throw console.error("\uD83C\uDFB5 [USE_TTS] Error playing TTS:",e),m(e=>({...e,[n]:!1})),g(!1),r(!1),o(null),e}},[])),b=((0,n.useCallback)(async(e,t)=>{h.current&&(h.current.pause(),h.current=null),m(e=>({...e,[t]:!0})),g(!0),r(!0);try{if(!await S(e,6,300))throw Error("Audio file not accessible");let o=new Audio(e);h.current=o,o.onended=()=>{console.log("\uD83C\uDFB5 [PLAY_EXISTING_TTS] TTS finished playing"),h.current=null,m(e=>({...e,[t]:!1})),g(!1),r(!1)},o.onerror=e=>{console.error("\uD83C\uDFB5 [PLAY_EXISTING_TTS] TTS audio error:",e),h.current=null,m(e=>({...e,[t]:!1})),g(!1),r(!1)},await o.play(),console.log("\uD83C\uDFB5 [PLAY_EXISTING_TTS] TTS started playing successfully")}catch(e){throw console.error("\uD83C\uDFB5 [PLAY_EXISTING_TTS] Error playing TTS:",e),m(e=>({...e,[t]:!1})),g(!1),r(!1),e}},[S]),(0,n.useCallback)(()=>{console.log("\uD83C\uDFB5 [STOP_TTS] Stopping TTS"),h.current&&(h.current.pause(),h.current=null),m({}),g(!1),r(!1),o(null)},[]),(0,n.useCallback)(()=>{console.log("\uD83C\uDFB5 [CLEAR_CACHE] Clearing TTS cache"),y.current.clear()},[]),(0,n.useCallback)(async()=>{if(l||0===a.length)return;c(!0);let[e,...r]=a;i(r);try{await x(e.text,e.language,e.cacheKey)}catch(e){console.error("\uD83C\uDFB5 [PROCESS_QUEUE] Error processing TTS queue:",e)}finally{c(!1)}},[l,a,x]));(0,n.useEffect)(()=>{!(a.length>0)||l||d||b()},[a,l,d,b])}();let rz=((e,r,t,o,a,i)=>{let[l,c]=(0,n.useState)([]),[d,g]=(0,n.useState)([]),[u,p]=(0,n.useState)(0),[f,m]=(0,n.useState)(!1),[h,y]=(0,n.useState)(!1),[S,x]=(0,n.useState)({}),[b,v]=(0,n.useState)({}),[T,w]=(0,n.useState)({}),[E,A]=(0,n.useState)(!1),[k,C]=(0,n.useState)(!1),I=(0,n.useCallback)(async()=>{if(e){console.log("\uD83D\uDD0D [DEBUG] fetchSuggestions called"),y(!0);try{let e=localStorage.getItem("jwt"),n=a.map(e=>({sender:e.sender,text:e.text,timestamp:e.timestamp}));console.log("\uD83D\uDD0D [DEBUG] Sending chat history to suggestions:",n.length,"messages"),console.log("\uD83D\uDD0D [DEBUG] Chat history details:",n);let l=await s.A.post("/api/suggestions",{conversationId:t,chat_history:n,language:r,user_level:(null==o?void 0:o.userLevel)||"beginner",user_topics:(null==o?void 0:o.topics)||[],formality:(null==o?void 0:o.formality)||"neutral",feedback_language:(null==o?void 0:o.feedbackLanguage)||"en"},{headers:{"Content-Type":"application/json",...e?{Authorization:"Bearer ".concat(e)}:{}}});console.log("\uD83D\uDD0D [DEBUG] Suggestions response:",l.data);let d=l.data.suggestions||[];if(c(d),d.length>0){x({}),w({}),v({}),A(!1),C(!1),console.log("\uD83D\uDD0D [DEBUG] Setting suggestions:",d);let e=d.map((e,t)=>{var o;let n=i((null==(o=e.text)?void 0:o.replace(/\*\*/g,""))||"",r);return{sender:"User",text:n.mainText,romanizedText:n.romanizedText||e.romanized||"",timestamp:new Date,messageType:"text",isSuggestion:!0,suggestionIndex:t,totalSuggestions:d.length,explanation:e.explanation||"",translation:e.translation||"",romanized:e.romanized||""}});console.log("\uD83D\uDD0D [DEBUG] Setting suggestionMessages:",e),g(e),p(0),m(!0),console.log("\uD83D\uDD0D [DEBUG] Set showSuggestionCarousel to true")}}catch(e){console.error("\uD83D\uDD0D [DEBUG] Error fetching suggestions:",e),c([])}finally{y(!1)}}},[e,r,t,o,a,i]),D=(0,n.useCallback)(async()=>{if(e){console.log("\uD83D\uDD0D [DEBUG] handleSuggestionButtonClick called"),y(!0);try{let e=localStorage.getItem("jwt");console.log("\uD83D\uDD0D [DEBUG] Suggestions request - language:",r),console.log("\uD83D\uDD0D [DEBUG] Suggestions request - userPreferences:",o);let n=a.map(e=>({sender:e.sender,text:e.text,timestamp:e.timestamp}));console.log("\uD83D\uDD0D [DEBUG] Sending chat history to suggestions (button click):",n.length,"messages"),console.log("\uD83D\uDD0D [DEBUG] Chat history details (button click):",n);let l=await s.A.post("/api/suggestions",{conversationId:t,chat_history:n,language:r,user_level:(null==o?void 0:o.userLevel)||"beginner",user_topics:(null==o?void 0:o.topics)||[],formality:(null==o?void 0:o.formality)||"neutral",feedback_language:(null==o?void 0:o.feedbackLanguage)||"en"},{headers:{"Content-Type":"application/json",...e?{Authorization:"Bearer ".concat(e)}:{}}});console.log("\uD83D\uDD0D [DEBUG] Suggestions response (button click):",l.data);let d=l.data.suggestions||[];if(d.length>0){x({}),w({}),v({}),A(!1),C(!1);let e=d.map((e,t)=>{var o;let n=i((null==(o=e.text)?void 0:o.replace(/\*\*/g,""))||"",r);return{sender:"User",text:n.mainText,romanizedText:n.romanizedText||e.romanized||"",timestamp:new Date,messageType:"text",isSuggestion:!0,suggestionIndex:t,totalSuggestions:d.length,explanation:e.explanation||"",translation:e.translation||"",romanized:e.romanized||""}});console.log("\uD83D\uDD0D [DEBUG] Setting suggestionMessages (button click):",e),g(e),c(d),p(0),m(!0),console.log("\uD83D\uDD0D [DEBUG] Set showSuggestionCarousel to true (button click)")}}catch(e){console.error("\uD83D\uDD0D [DEBUG] Error fetching suggestions (button click):",e),c([])}finally{y(!1)}}},[e,r,t,o,a,i]),R=(0,n.useCallback)(e=>{"prev"===e?p(e=>e>0?e-1:l.length-1):p(e=>e<l.length-1?e+1:0)},[l.length]),j=(0,n.useCallback)(()=>{p(0),c([]),g([]),m(!1),x({}),w({}),v({}),A(!1)},[]),_=(0,n.useCallback)(async(t,n)=>{v(e=>({...e,[t]:!0}));try{let i=localStorage.getItem("jwt"),l=await s.A.post("/api/explain_suggestion",{suggestion_text:n,chatHistory:a,language:r,user_level:(null==o?void 0:o.userLevel)||"beginner",user_topics:(null==o?void 0:o.topics)||[],formality:(null==o?void 0:o.formality)||"neutral",feedback_language:(null==o?void 0:o.feedbackLanguage)||"en",user_goals:(null==e?void 0:e.learning_goals)?"string"==typeof e.learning_goals?JSON.parse(e.learning_goals):e.learning_goals:[]},{headers:{"Content-Type":"application/json",...i?{Authorization:"Bearer ".concat(i)}:{}}});l.data.success&&(x(e=>({...e,[t]:{translation:l.data.explanation,breakdown:l.data.breakdown,has_breakdown:!0}})),w(e=>({...e,[t]:!0})))}catch(e){console.error("Error explaining suggestion:",e)}finally{v(e=>({...e,[t]:!1}))}},[r,a,o,e]);return{suggestions:l,setSuggestions:c,suggestionMessages:d,setSuggestionMessages:g,currentSuggestionIndex:u,setCurrentSuggestionIndex:p,showSuggestionCarousel:f,setShowSuggestionCarousel:m,isLoadingSuggestions:h,setIsLoadingSuggestions:y,suggestionTranslations:S,setSuggestionTranslations:x,isTranslatingSuggestion:b,setIsTranslatingSuggestion:v,showSuggestionTranslations:T,setShowSuggestionTranslations:w,showSuggestionExplanations:E,setShowSuggestionExplanations:A,explainButtonPressed:k,setExplainButtonPressed:C,fetchSuggestions:I,handleSuggestionButtonClick:D,navigateSuggestion:R,clearSuggestionCarousel:j,explainSuggestion:_,playSuggestionTTS:(0,n.useCallback)(async(e,t)=>{console.log("[DEBUG] Playing suggestion TTS:",e.text,t);try{let o=localStorage.getItem("jwt"),n=await s.A.post("/api/tts",{text:e.text,language:r,cacheKey:"suggestion_".concat(t,"_").concat(Date.now())},{headers:{"Content-Type":"application/json",...o?{Authorization:"Bearer ".concat(o)}:{}}});if(n.data.ttsUrl){let e=new Audio(n.data.ttsUrl);await e.play()}}catch(e){console.error("Error playing suggestion TTS:",e)}},[r])}})(t,y,C,rk,rF,I),rU=((e,r,t,o,a,i,s,c,d,u,p,f,m,h)=>{let y=(0,l.useRouter)(),[S,x]=(0,n.useState)(!1),b=(0,n.useCallback)(async()=>{if((null==e?void 0:e.id)&&r){console.log("[DEBUG] Language changed to:",r,"- reloading preferences");try{let t=await Q(r,e.id);t?(console.log("[DEBUG] Loaded preferences for",r,":",t),d(e=>({...e,userLevel:t.proficiency_level,topics:t.talk_topics,user_goals:t.learning_goals,romanizationDisplay:t.romanization_display,formality:(null==e?void 0:e.formality)||"friendly",feedbackLanguage:(null==e?void 0:e.feedbackLanguage)||"en"}))):(console.log("[DEBUG] No dashboard found for language:",r,"- using defaults"),d(e=>({...e,userLevel:"beginner",topics:[],user_goals:[],romanizationDisplay:"both"})))}catch(e){console.error("[DEBUG] Error loading preferences for language:",r,e)}}},[e,r,d]),v=(0,n.useCallback)(async r=>{if(!e)return void console.warn("[CONVERSATION_LOAD] No user available, cannot load conversation");if(S)return void console.log("[CONVERSATION_LOAD] Already loading conversation, skipping");console.log("[CONVERSATION_LOAD] Starting to load conversation:",r),x(!0);try{let e=await ee(r);if(e){var t;console.log("[CONVERSATION_LOAD] Successfully loaded conversation with",(null==(t=e.messages)?void 0:t.length)||0,"messages"),a(e.messages||[]),console.log("[CONVERSATION_LOAD] Setting conversation ID from result:",e.conversationId,"Type:",typeof e.conversationId),i(String(e.conversationId)),s(e.description||""),console.log("[CONVERSATION_LOAD] Conversation loaded successfully, ready for continuation"),console.log("[CONVERSATION_LOAD] Processing persona information:",{usesPersona:e.usesPersona,personaId:e.personaId,usesPersonaType:typeof e.usesPersona,usesPersonaTruthy:!!e.usesPersona}),!0===e.usesPersona?(h(!0),console.log("[CONVERSATION_LOAD] Conversation uses persona, setting isUsingPersona to true")):(h(!1),console.log("[CONVERSATION_LOAD] Conversation does not use persona, setting isUsingPersona to false")),e.language&&console.log("[CONVERSATION_LOAD] Conversation language:",e.language),e.formality&&(d(r=>({...r,formality:e.formality})),console.log("[CONVERSATION_LOAD] Set formality:",e.formality)),e.topics&&(d(r=>({...r,topics:e.topics})),console.log("[CONVERSATION_LOAD] Set topics:",e.topics)),e.learningGoals&&(d(r=>({...r,user_goals:e.learningGoals})),console.log("[CONVERSATION_LOAD] Set learning goals:",e.learningGoals)),e.selectedSubgoals&&(d(r=>({...r,selected_subgoals:e.selectedSubgoals})),console.log("[CONVERSATION_LOAD] Set selected subgoals:",e.selectedSubgoals)),e.createdAt&&(c(new Date(e.createdAt)),console.log("[CONVERSATION_LOAD] Set session start time:",e.createdAt))}else{console.warn("[CONVERSATION_LOAD] No conversation data returned for ID:",r),a([]),i(null),s(""),c(null),h(!1);let e={sender:"System",text:"❌ Conversation not found. The conversation with ID ".concat(r," may have been deleted or you may not have access to it."),timestamp:new Date,isFromOriginalConversation:!1};a([e])}}catch(e){console.error("[CONVERSATION_LOAD] Error loading conversation:",e),a([]),i(null),s(""),c(null),h(!1),a([{sender:"System",text:"❌ Error loading conversation. Please try refreshing the page or contact support if the problem persists.",timestamp:new Date,isFromOriginalConversation:!1}])}finally{x(!1)}},[e,a,i,s,d,c,h]),T=(0,n.useCallback)(async function(t,o,n,a){let s=arguments.length>4&&void 0!==arguments[4]&&arguments[4],l=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;if(!e)return null;let c=await Z(t,o,n,a,r,e,s,l);return c&&i(c),c},[e,r,i]),w=(0,n.useCallback)(async(t,o,n,a)=>{if(!e||!a)return!1;try{console.log("\uD83D\uDD0D [CONVERSATION_MANAGEMENT] Calling generateConversationSummary with:",{sessionMessages:t.length,language:r,topics:o,formality:n,conversationId:a});let i=await et(t,r,o,n,a);if(console.log("\uD83D\uDD0D [CONVERSATION_MANAGEMENT] generateConversationSummary returned:",i),i){console.log("\uD83D\uDD0D [CONVERSATION_MANAGEMENT] Summary received:",i);let r=i.learningGoals||[];console.log("\uD83D\uDD0D [CONVERSATION_MANAGEMENT] Progress percentages:",r),console.log("\uD83D\uDD0D [CONVERSATION_MANAGEMENT] Progress percentages length:",r.length),console.log("\uD83D\uDD0D [CONVERSATION_MANAGEMENT] Progress percentages type:",typeof r),console.log("\uD83D\uDD0D [CONVERSATION_MANAGEMENT] Progress percentages is array:",Array.isArray(r));let t=Object.values(m),o=[];console.log("\uD83D\uDD0D [CONVERSATION_MANAGEMENT] User object:",e),console.log("\uD83D\uDD0D [CONVERSATION_MANAGEMENT] User learning_goals raw:",null==e?void 0:e.learning_goals);let n=(null==e?void 0:e.learning_goals)?"string"==typeof e.learning_goals?JSON.parse(e.learning_goals):e.learning_goals:[];console.log("\uD83D\uDD0D [CONVERSATION_MANAGEMENT] User learning goals parsed:",n);let a=[],s=[];n.forEach(e=>{let r=g.Kq.find(r=>r.id===e);(null==r?void 0:r.subgoals)&&r.subgoals.forEach(e=>{a.push(e.id),s.push(r.goal)})});for(let e=0;e<Math.min(r.length,a.length);e++){let n=a[e],i=r[e],s=(0,g.o8)(n,i,t);s.levelUpEvent&&o.push(s.levelUpEvent),t.splice(0,t.length,...s.updatedProgress)}let l=t.reduce((e,r)=>(e[r.subgoalId]=r,e),{});if(f(l),n.length>0||r.length>0)return console.log("\uD83D\uDD0D [CONVERSATION_MANAGEMENT] Showing progress modal with data:",{percentages:r,subgoalNames:s.slice(0,Math.max(r.length,n.length)),levelUpEvents:o,hasUserGoals:n.length>0,hasProgressData:r.length>0}),p({percentages:r,subgoalNames:s.length>0?s.slice(0,Math.max(r.length,n.length)):["Goal 1","Goal 2","Goal 3"].slice(0,r.length),subgoalIds:a.slice(0,Math.max(r.length,n.length)),levelUpEvents:o}),u(!0),!0;console.log("\uD83D\uDD0D [CONVERSATION_MANAGEMENT] No user learning goals or progress data found, not showing progress modal")}return!1}catch(e){return console.error("Error generating conversation summary:",e),!1}},[e,r,f,p,u]),E=(0,n.useCallback)(async(t,o,n,l,g,u,p,f)=>{console.log("[CONVERSATION_START] Starting new conversation:",{conversationId:t,topics:o,formality:l,learningGoals:g,selectedSubgoals:f,description:u,isUsingExistingPersona:p}),i(t),a([]),c(null),s(u||""),p?(h(!0),console.log("[CONVERSATION_START] Using existing persona, setting isUsingPersona to true")):(h(!1),console.log("[CONVERSATION_START] Not using existing persona, setting isUsingPersona to false")),u&&u.trim();let m=await Q(r,e.id),S=(null==m?void 0:m.romanization_display)||"both";if(d(e=>({...e,formality:l,topics:o,user_goals:g,selected_subgoals:f||[],romanizationDisplay:S})),y.replace("/analyze?conversation=".concat(t,"&topics=").concat(encodeURIComponent(o.join(",")))),n&&n.text&&n.text.trim()){let e={mainText:n.text,romanizedText:""};a([{sender:"AI",text:e.mainText,romanizedText:e.romanizedText,ttsUrl:n.ttsUrl||null,timestamp:new Date,isFromOriginalConversation:!1}]),n.ttsUrl&&null!==n.ttsUrl?console.log("\uD83D\uDD0D [INITIAL_TTS] Playing initial AI message TTS:",n.ttsUrl):console.log("\uD83D\uDD0D [INITIAL_TTS] No TTS URL provided for initial message, will generate TTS on demand")}else console.log("\uD83D\uDD0D [DEBUG] No AI message or empty text, setting default message"),a([{sender:"AI",text:"Hello! What would you like to talk about today?",timestamp:new Date,isFromOriginalConversation:!1}])},[r,e,i,a,c,s,d,h,y]);return(0,n.useEffect)(()=>{e&&r&&b()},[e,r,b]),{isLoadingConversation:S,loadConversation:v,saveSession:T,generateSummary:w,handleModalConversationStart:E,loadPreferencesForLanguage:b}})(t,y,0,0,rB,D,j,N,rC,e2,e8,ry,rh,ef);(0,n.useEffect)(()=>{console.log("[CONVERSATION_ID_DEBUG] Conversation ID changed:",{conversationId:C,conversationIdType:typeof C,conversationIdTruthy:!!C,urlConversationId:u,loadedConversationId:G,isLoadingConversation:O,isUsingPersona:ep,usePersona:f})},[C,u,G,O,ep,f]),(0,n.useEffect)(()=>{console.log("[TTS_STATE_DEBUG] TTS state changed:",{isAnyTTSPlaying:ew,isPlayingAITTS:rd,isPlayingShortFeedbackTTS:rl,aiTTSQueued:!!eA,shortFeedbackTTSQueued:!!eC})},[ew,rd,rl,eA,eC]);let rM=((e,r,t,o,a,i,s,l,c,d,g,u,p,f,m,h)=>{let y=(0,n.useRef)(null),S=(0,n.useRef)(null),x=(0,n.useRef)([]),b=(0,n.useRef)(!1),v=(0,n.useRef)(!1),T=(0,n.useRef)(l),w=(0,n.useRef)(null),E=(0,n.useRef)(null),[A,k]=(0,n.useState)(!1),[C,I]=(0,n.useState)(!1),[D,R]=(0,n.useState)(null),[j,_]=(0,n.useState)(!1),N=(0,n.useRef)(null),O=(0,n.useRef)(!1),P=(0,n.useRef)(null);T.current=l,n.useEffect(()=>{console.log("\uD83D\uDD0D [DEBUG] useAudioHandlers initialized, clearing any stuck recording messages"),i(e=>e.filter(e=>!(e.isRecording&&"User"===e.sender)))},[]);let F=(0,n.useCallback)(async()=>{if(console.log("\uD83D\uDD0D [DEBUG] handleStartRecording called"),console.log("\uD83D\uDD0D [DEBUG] Current state check:",{isAnyTTSPlaying:d,conversationId:t,conversationIdType:typeof t,isProcessingAudioRef:O.current,mediaRecorderSupported:!!w.current,speechRecognitionSupported:!!E.current}),I(!1),b.current=!1,v.current=!1,O.current=!1,P.current=null,d)return void console.log("\uD83D\uDD0D [DEBUG] Cannot start recording - TTS is playing:",{isAnyTTSPlaying:d});let e={id:"recording_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9)),sender:"User",text:"\uD83C\uDFA4 Recording...",romanizedText:"",timestamp:new Date,isFromOriginalConversation:!1,isRecording:!0};if(console.log("\uD83D\uDD0D [DEBUG] Adding recording message to chat history"),i(r=>[...r,e]),h&&(console.log("\uD83D\uDD0D [DEBUG] Clearing suggestion carousel due to recording start"),h()),!w.current)return void alert("MediaRecorder API not supported in this browser.");if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return void alert("Microphone access is not available in this browser. Please use a modern browser with microphone support.");try{let e=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:16e3,channelCount:1,latency:.01}});R(e),x.current=[];let t=MediaRecorder.isTypeSupported("audio/webm;codecs=opus")?"audio/webm;codecs=opus":MediaRecorder.isTypeSupported("audio/webm")?"audio/webm":"audio/wav";console.log("\uD83D\uDD0D [DEBUG] Using MIME type:",t);let o=new w.current(e,{mimeType:t});if(S.current=o,o.ondataavailable=e=>{e.data.size>0&&(console.log("\uD83D\uDD0D [DEBUG] Audio chunk received:",e.data.size,"bytes"),x.current.push(e.data))},o.onstop=()=>{if(console.log("\uD83D\uDD0D [DEBUG] MediaRecorder onstop event triggered"),console.log("\uD83D\uDD0D [DEBUG] interruptedRef.current:",b.current),console.log("\uD83D\uDD0D [DEBUG] manualStopRef.current:",v.current),console.log("\uD83D\uDD0D [DEBUG] isProcessingAudioRef.current:",O.current),console.log("\uD83D\uDD0D [DEBUG] audioChunksRef.current length:",x.current.length),console.log("\uD83D\uDD0D [DEBUG] Total audio chunks size:",x.current.reduce((e,r)=>e+r.size,0),"bytes"),O.current)return void console.log("\uD83D\uDD0D [DEBUG] Audio already being processed, ignoring duplicate onstop event");if(b.current){console.log("\uD83D\uDD0D [DEBUG] Recording was interrupted, cleaning up"),b.current=!1,v.current=!1,I(!0),e.getTracks().forEach(e=>e.stop()),R(null),k(!1),_(!1);return}if(v.current&&(console.log("\uD83D\uDD0D [DEBUG] Manual stop detected, processing audio"),v.current=!1),O.current=!0,console.log("\uD83D\uDD0D [DEBUG] Creating audio blob and sending to backend"),0===x.current.length){console.error("\uD83D\uDD0D [DEBUG] No audio chunks recorded!"),i(e=>{let r=e.filter(e=>!(e.isRecording&&"User"===e.sender)),t={sender:"System",text:"❌ No audio recorded. Please try again.",timestamp:new Date,isFromOriginalConversation:!1};return[...r,t]});return}let r=new Blob(x.current,{type:t});if(console.log("\uD83D\uDD0D [DEBUG] Audio blob created:",{size:r.size,type:r.type,chunks:x.current.length,mimeType:t,actualMimeType:r.type,mimeTypeMatch:r.type===t}),0===r.size){console.error("\uD83D\uDD0D [DEBUG] Audio blob is empty!"),i(e=>{let r=e.filter(e=>!(e.isRecording&&"User"===e.sender)),t={sender:"System",text:"❌ Empty audio recorded. Please try again.",timestamp:new Date,isFromOriginalConversation:!1};return[...r,t]});return}W(r),e.getTracks().forEach(e=>e.stop()),R(null),k(!1),_(!1)},o.start(100),k(!0),N.current=setTimeout(()=>{console.log("\uD83D\uDD0D [DEBUG] Recording timeout reached, stopping recording automatically"),B(!1)},3e4),T.current){if(!E.current)return void alert("SpeechRecognition API not supported in this browser.");let e=new E.current;y.current=e,e.lang=r||"en-US",e.interimResults=!1,e.continuous=!1,T.current&&(e.maxAlternatives=1,setTimeout(()=>{y.current&&(console.log("[DEBUG] Autospeak: Speech recognition timeout reached, stopping recording"),y.current.stop())},eo.autospeak)),e.onresult=e=>{k(!1),S.current&&"inactive"!==S.current.state&&S.current.stop()},e.onerror=e=>{k(!1),S.current&&"inactive"!==S.current.state&&S.current.stop(),alert("Speech recognition error: "+e.error)},e.onend=()=>{k(!1),S.current&&"inactive"!==S.current.state&&S.current.stop()},e.start(),_(!1)}else _(!0)}catch(e){console.error("Error starting recording:",e),alert("Failed to access microphone. Please check permissions."),i(e=>e.filter(e=>!(e.isRecording&&"User"===e.sender)))}},[r,d]),B=(0,n.useCallback)(function(){let e=!(arguments.length>0)||void 0===arguments[0]||arguments[0];console.log("\uD83D\uDD0D [DEBUG] handleStopRecording called, isManualStop:",e),N.current&&(clearTimeout(N.current),N.current=null),e?(v.current=!0,console.log("\uD83D\uDD0D [DEBUG] Manual stop detected, setting manualStopRef to true")):(b.current=!0,console.log("\uD83D\uDD0D [DEBUG] Interruption detected, setting interruptedRef to true")),y.current&&(y.current.stop(),y.current=null),S.current&&"inactive"!==S.current.state&&S.current.stop(),D&&(D.getTracks().forEach(e=>e.stop()),R(null)),k(!1),_(!1)},[D]),G=(0,n.useCallback)(()=>{N.current&&(clearTimeout(N.current),N.current=null),b.current=!1,v.current=!1,O.current=!1},[]),W=(0,n.useCallback)(async e=>{console.log("\uD83D\uDD0D [DEBUG] sendAudioToBackend called with audioBlob:",e),console.log("\uD83D\uDD0D [DEBUG] sendAudioToBackend conversationId:",t,"type:",typeof t);let n="".concat(e.size,"_").concat(e.type,"_").concat(Date.now());if(P.current===n)return void console.log("\uD83D\uDD0D [DEBUG] Audio blob already processed, skipping duplicate processing");if(P.current=n,!(e instanceof Blob)){console.error("\uD83D\uDD0D [DEBUG] Invalid audio blob provided"),i(e=>e.filter(e=>!(e.isRecording&&"User"===e.sender)));return}try{console.log("\uD83D\uDD0D [DEBUG] Starting audio processing..."),s(!0),i(e=>{console.log("\uD83D\uDD0D [DEBUG] ===== SETCHATHISTORY CALLED (PROCESSING) ====="),console.log("\uD83D\uDD0D [DEBUG] Current chat history length before processing update:",e.length),console.log("\uD83D\uDD0D [DEBUG] Recording messages in history:",e.filter(e=>e.isRecording&&"User"===e.sender).length),console.log("\uD83D\uDD0D [DEBUG] All user messages before processing:",e.filter(e=>"User"===e.sender).map(e=>({text:e.text,isProcessing:e.isProcessing,isRecording:e.isRecording,id:e.id})));let r=e.map((e,r)=>e.isRecording&&"User"===e.sender?(console.log("\uD83D\uDD0D [DEBUG] Replacing recording message with processing message"),{...e,text:"\uD83C\uDFA4 Processing your message...",isRecording:!1,isProcessing:!0}):e);if(!r.some(e=>e.isProcessing&&"User"===e.sender)){console.log("\uD83D\uDD0D [DEBUG] No recording message found, adding processing message as fallback");let e={id:"processing_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9)),sender:"User",text:"\uD83C\uDFA4 Processing your message...",romanizedText:"",timestamp:new Date,isFromOriginalConversation:!1,isProcessing:!0},t=[...r,e];return console.log("\uD83D\uDD0D [DEBUG] Final chat history length after processing fallback:",t.length),console.log("\uD83D\uDD0D [DEBUG] ===== SETCHATHISTORY COMPLETED (PROCESSING FALLBACK) ====="),t}return console.log("\uD83D\uDD0D [DEBUG] Final chat history length after processing replacement:",r.length),console.log("\uD83D\uDD0D [DEBUG] ===== SETCHATHISTORY COMPLETED (PROCESSING REPLACEMENT) ====="),r}),console.log("\uD83D\uDD0D [DEBUG] Calling processAudioWithPipeline...");let n=new Promise((e,r)=>{setTimeout(()=>r(Error("Transcription timeout after 30 seconds")),3e4)}),d=await Promise.race([L(e,r,a,o,l,c),n]);if(console.log("\uD83D\uDD0D [DEBUG] processAudioWithPipeline completed:",d),i(e=>{console.log("\uD83D\uDD0D [DEBUG] ===== SETCHATHISTORY CALLED ====="),console.log("\uD83D\uDD0D [DEBUG] Current chat history length before update:",e.length),console.log("\uD83D\uDD0D [DEBUG] Processing messages in history:",e.filter(e=>e.isProcessing&&"User"===e.sender).length),console.log("\uD83D\uDD0D [DEBUG] All user messages:",e.filter(e=>"User"===e.sender).map(e=>({text:e.text,isProcessing:e.isProcessing,isRecording:e.isRecording,id:e.id})));let r="transcription_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9));if(console.log("\uD83D\uDD0D [DEBUG] Generated transcription ID:",r),e.some(e=>"User"===e.sender&&e.text===d.transcription&&!e.isProcessing&&!e.isRecording&&e.id!==r)){console.log("\uD83D\uDD0D [DEBUG] Transcription already exists, preventing duplicate");let r=e.filter(e=>!(e.isProcessing&&"User"===e.sender));return console.log("\uD83D\uDD0D [DEBUG] Filtered chat history length:",r.length),r}let t=e.map((e,t)=>e.isProcessing&&"User"===e.sender?(console.log("\uD83D\uDD0D [DEBUG] Replacing processing message with actual transcription:",d.transcription),{...e,id:r,text:d.transcription,romanizedText:d.userMessage.romanizedText,isProcessing:!1}):e);if(!t.some(e=>e.text===d.transcription&&"User"===e.sender&&!e.isProcessing)){console.log("\uD83D\uDD0D [DEBUG] No processing message found, adding transcription message as fallback");let e={id:r,sender:"User",text:d.transcription,romanizedText:d.userMessage.romanizedText,timestamp:new Date,isFromOriginalConversation:!1,isProcessing:!1},o=[...t,e];return console.log("\uD83D\uDD0D [DEBUG] Final chat history length after fallback:",o.length),console.log("\uD83D\uDD0D [DEBUG] ===== SETCHATHISTORY COMPLETED (FALLBACK) ====="),o}return console.log("\uD83D\uDD0D [DEBUG] Final chat history length after replacement:",t.length),console.log("\uD83D\uDD0D [DEBUG] ===== SETCHATHISTORY COMPLETED (REPLACEMENT) ====="),t}),h&&(console.log("\uD83D\uDD0D [DEBUG] Clearing suggestion carousel due to new user transcription"),h()),console.log("[MESSAGE_SAVE] Conversation ID check:",{conversationId:t,conversationIdType:typeof t,conversationIdTruthy:!!t,chatHistoryLength:a.length,chatHistoryMessages:a.map(e=>({sender:e.sender,text:e.text.substring(0,50)}))}),t?(console.log("[MESSAGE_SAVE] Saving user message to conversation:",t),await er(d.userMessage,t,a.length+1)):console.warn("[MESSAGE_SAVE] No conversation ID available for user message"),d.shortFeedback)if(p(d.shortFeedback),l){let e="short_feedback_".concat(Date.now());console.log("[DEBUG] Queuing short feedback TTS to play after AI response (autospeak is ON)"),m({text:d.shortFeedback,language:r,cacheKey:e})}else console.log("[DEBUG] Skipping short feedback TTS (autospeak is OFF)");if(d.aiMessage){let e={sender:"AI",text:"\uD83E\uDD16 Processing AI response...",romanizedText:"",timestamp:new Date,isFromOriginalConversation:!1,isProcessing:!0};console.log("\uD83D\uDD0D [DEBUG] Adding AI processing message to chat history"),i(r=>[...r,e]),i(e=>e.map((e,r)=>e.isProcessing&&"AI"===e.sender?{...e,text:d.aiMessage.text,romanizedText:d.aiMessage.romanizedText,ttsUrl:null,isProcessing:!1}:e)),t?(console.log("[MESSAGE_SAVE] Saving AI message to conversation:",t),await er(d.aiMessage,t,a.length+2)):console.warn("[MESSAGE_SAVE] No conversation ID available for AI message"),console.log("[DEBUG] Playing TTS for AI response immediately");let n=((e,r,t)=>"both"===r&&e.romanizedText?"".concat(e.romanizedText," (").concat(e.text,")"):"romanized"===r&&e.romanizedText?e.romanizedText:e.text)(d.aiMessage,(null==o?void 0:o.romanizationDisplay)||"both",0),s="ai_message_auto_".concat(Date.now());l?console.log("[DEBUG] Autospeak mode: AI TTS will be handled by queue system"):(console.log("[DEBUG] Manual mode: Playing AI TTS immediately"),g(!0),M(n,r,s,e=>{g(e)}).catch(e=>{console.error("[DEBUG] Error playing AI TTS:",e),g(!1)})),l&&(console.log("[DEBUG] Adding AI response TTS to queue for autospeak mode"),u({text:n,language:r,cacheKey:s}))}else{console.log("\uD83D\uDD0D [DEBUG] No AI response found!");let e={sender:"AI",text:"Hello! What would you like to talk about today?",romanizedText:"",timestamp:new Date,isFromOriginalConversation:!1};i(r=>r.map((r,t)=>r.isProcessing&&"AI"===r.sender?(console.log("\uD83D\uDD0D [DEBUG] Replacing processing message with fallback"),e):r))}}catch(e){var d,f;console.error("\uD83D\uDD0D [DEBUG] Error processing audio:",e),console.error("\uD83D\uDD0D [DEBUG] Error details:",{message:null==e?void 0:e.message,status:null==e||null==(d=e.response)?void 0:d.status,data:null==e||null==(f=e.response)?void 0:f.data,stack:null==e?void 0:e.stack}),i(r=>[...r.filter(e=>!(e.isProcessing&&"User"===e.sender)&&!(e.isRecording&&"User"===e.sender)),{sender:"System",text:"❌ Error processing audio: ".concat((null==e?void 0:e.message)||"Unknown error",". Please try again."),timestamp:new Date,isFromOriginalConversation:!1}])}finally{console.log("\uD83D\uDD0D [DEBUG] Audio processing completed, setting isProcessing to false"),s(!1),O.current=!1}},[r,a,o,l,c,t,i,s,p,u,g,f]);return{isRecording:A,wasInterrupted:C,manualRecording:j,handleStartRecording:F,handleStopRecording:B,handlePlayTTS:(0,n.useCallback)(async(e,r)=>{try{z&&(console.log("\uD83D\uDD0A [AUDIO_HANDLERS] TTS already playing, stopping current TTS first"),U(),g(!1));let t="manual_tts_".concat(Date.now());g(!0),await M(e,r,t,e=>{g(e)})}catch(e){console.error("Error playing TTS:",e),g(!1)}},[g]),handlePlayExistingTTS:(0,n.useCallback)(async e=>{try{console.log("\uD83D\uDD0D [EXISTING_TTS] Attempting to play existing TTS:",e),z&&(console.log("\uD83D\uDD0A [EXISTING_TTS] TTS already playing, stopping current TTS first"),U(),g(!1));let r=en(e);if(console.log("\uD83D\uDD0D [EXISTING_TTS] Constructed absolute URL:",r),!await ea(e))throw Error("TTS file is not accessible");let t=new Audio(r);g(!0),t.addEventListener("error",e=>{console.error("\uD83D\uDD0D [EXISTING_TTS] Audio load error:",e),console.warn("\uD83D\uDD0D [EXISTING_TTS] Audio file may be corrupted or in unsupported format"),g(!1)}),t.addEventListener("canplaythrough",()=>{console.log("\uD83D\uDD0D [EXISTING_TTS] Audio loaded successfully, playing...")}),t.addEventListener("ended",()=>{console.log("\uD83D\uDD0D [EXISTING_TTS] TTS finished playing"),g(!1)}),await t.play(),console.log("\uD83D\uDD0D [EXISTING_TTS] Successfully playing existing TTS")}catch(e){console.error("\uD83D\uDD0D [EXISTING_TTS] Failed to play existing TTS audio:",e),console.warn("\uD83D\uDD0D [EXISTING_TTS] The TTS file may be missing, inaccessible, or corrupted"),g(!1)}},[g]),cleanup:G,recognitionRef:y,mediaRecorderRef:S,MediaRecorderClassRef:w,SpeechRecognitionClassRef:E}})(0,y,C,rk,rF,rB,T,w,A,ew,eE,ek,eL,rc,eI,rz.clearSuggestionCarousel);(0,n.useEffect)(()=>{console.log("[AUDIO_HANDLERS_DEBUG] Audio handlers conversationId:",C)},[C]);let rL=(e=>{let[r,t]=(0,n.useState)({}),[o,a]=(0,n.useState)({}),[i,l]=(0,n.useState)({}),[c,d]=(0,n.useState)({}),[g,u]=(0,n.useState)({}),[p,f]=(0,n.useState)({}),[m,h]=(0,n.useState)({}),[y,S]=(0,n.useState)({}),[x,b]=(0,n.useState)({}),[v,T]=(0,n.useState)({}),w=(0,n.useCallback)(async(r,o,n,a,i,l,c,d)=>{if(i){t(e=>({...e,[r]:!0}));try{let t=localStorage.getItem("jwt"),o=n[r],i=(null==o?void 0:o.text)||"",g=n.slice(-4).map(e=>"".concat(e.sender,": ").concat(e.text)).join("\n");if(c&&d&&(!a.romanizationDisplay||"both"===a.romanizationDisplay)){let r=await c(e||"en");r&&d(e=>({...e,romanizationDisplay:r.romanization_display||"both"}))}let u={user_input:i,context:g,language:e,user_level:a.userLevel,user_topics:a.topics,romanization_display:a.romanizationDisplay},p=(await s.A.post("/api/feedback",u,t?{headers:{Authorization:"Bearer ".concat(t)}}:void 0)).data.feedback,f=((e,r)=>{for(let t of[/([^(]+?)\s*[(:]\s*([^)]+?)\)?$/,/([^(]+?)\s*[(:]\s*([^)]+?)\)?$/,/(?:here's the corrected version|corrected version):\s*(.+?)(?:\n|$)/i]){let o=e.match(t);if(o){let e=o[1].trim(),t=o[2].trim();if("above"===r||"below"===r)return{mainText:e};return{mainText:e,romanizedText:t}}}return null})(p,a.romanizationDisplay||"both"),m=(e=>{let r,t={},o=/(?:Grammar|Pronunciation|Vocabulary|Culture|Usage|Style|Tone|Formality|Politeness|Context|Meaning|Structure|Word Order|Particles|Honorifics|Formal Language|Informal Language|Casual Language|Business Language|Academic Language|Everyday Language|Conversational Language|Written Language|Spoken Language|Regional Variation|Dialect|Accent|Intonation|Stress|Rhythm|Pacing|Clarity|Fluency|Accuracy|Naturalness|Appropriateness|Effectiveness|Impact|Engagement|Connection|Understanding|Comprehension|Learning|Improvement|Progress|Development|Growth|Mastery|Proficiency|Skill|Ability|Competence|Confidence|Motivation|Interest|Curiosity|Exploration|Discovery|Insight|Awareness|Knowledge|Wisdom|Experience|Practice|Repetition|Consistency|Persistence|Patience|Dedication|Commitment|Effort|Hard Work|Time|Energy|Focus|Attention|Concentration|Memory|Recall|Recognition|Association|Connection|Pattern|Rule|Principle|Concept|Idea|Thought|Understanding|Comprehension|Analysis|Synthesis|Evaluation|Application|Practice|Exercise|Drill|Review|Revision|Correction|Feedback|Guidance|Instruction|Teaching|Learning|Study|Research|Investigation|Exploration|Discovery|Innovation|Creativity|Imagination|Inspiration|Motivation|Encouragement|Support|Help|Assistance|Guidance|Mentorship|Coaching|Tutoring|Teaching|Instruction|Education|Training|Development|Growth|Improvement|Progress|Success|Achievement|Accomplishment|Mastery|Proficiency|Skill|Ability|Competence|Confidence|Self-Esteem|Self-Confidence|Self-Assurance|Self-Belief|Self-Trust|Self-Reliance|Independence|Autonomy|Freedom|Liberty|Choice|Option|Alternative|Possibility|Opportunity|Chance|Potential|Capability|Capacity|Power|Strength|Force|Energy|Vitality|Life|Living|Existence|Being|Presence|Awareness|Consciousness|Mind|Thought|Thinking|Reasoning|Logic|Rationality|Intelligence|Wisdom|Knowledge|Understanding|Comprehension|Insight|Perception|Awareness|Consciousness|Mindfulness|Attention|Focus|Concentration|Meditation|Reflection|Contemplation|Introspection|Self-Awareness|Self-Reflection|Self-Examination|Self-Analysis|Self-Evaluation|Self-Assessment|Self-Improvement|Self-Development|Self-Growth|Self-Transformation|Self-Realization|Self-Actualization|Self-Fulfillment|Self-Satisfaction|Self-Contentment|Self-Happiness|Self-Joy|Self-Bliss|Self-Peace|Self-Harmony|Self-Balance|Self-Equilibrium|Self-Stability|Self-Security|Self-Safety|Self-Protection|Self-Defense|Self-Preservation|Self-Survival|Self-Existence|Self-Being|Self-Presence|Self-Awareness|Self-Consciousness|Self-Mindfulness|Self-Attention|Self-Focus|Self-Concentration|Self-Meditation|Self-Reflection|Self-Contemplation|Self-Introspection|Self-Self-Awareness|Self-Self-Reflection|Self-Self-Examination|Self-Self-Analysis|Self-Self-Evaluation|Self-Self-Assessment|Self-Self-Improvement|Self-Self-Development|Self-Self-Growth|Self-Self-Transformation|Self-Self-Realization|Self-Self-Actualization|Self-Self-Fulfillment|Self-Self-Satisfaction|Self-Self-Contentment|Self-Self-Happiness|Self-Self-Joy|Self-Self-Bliss|Self-Self-Peace|Self-Self-Harmony|Self-Self-Balance|Self-Self-Equilibrium|Self-Self-Stability|Self-Self-Security|Self-Self-Safety|Self-Self-Protection|Self-Self-Defense|Self-Self-Preservation|Self-Self-Survival|Self-Self-Existence|Self-Self-Being|Self-Self-Presence|Self-Self-Awareness|Self-Self-Consciousness|Self-Self-Mindfulness|Self-Self-Attention|Self-Self-Focus|Self-Self-Concentration|Self-Self-Meditation|Self-Self-Reflection|Self-Self-Contemplation|Self-Self-Introspection|Self-Self-Self-Awareness|Self-Self-Self-Reflection|Self-Self-Self-Examination|Self-Self-Self-Analysis|Self-Self-Self-Evaluation|Self-Self-Self-Assessment|Self-Self-Self-Improvement|Self-Self-Self-Development|Self-Self-Self-Growth|Self-Self-Self-Transformation|Self-Self-Self-Realization|Self-Self-Self-Actualization|Self-Self-Self-Fulfillment|Self-Self-Self-Satisfaction|Self-Self-Self-Contentment|Self-Self-Self-Happiness|Self-Self-Self-Joy|Self-Self-Self-Bliss|Self-Self-Self-Peace|Self-Self-Self-Harmony|Self-Self-Self-Balance|Self-Self-Self-Equilibrium|Self-Self-Self-Stability|Self-Self-Self-Security|Self-Self-Self-Safety|Self-Self-Self-Protection|Self-Self-Self-Defense|Self-Self-Self-Preservation|Self-Self-Self-Survival|Self-Self-Self-Existence|Self-Self-Self-Being|Self-Self-Self-Presence|Self-Self-Self-Awareness|Self-Self-Self-Consciousness|Self-Self-Self-Mindfulness|Self-Self-Self-Attention|Self-Self-Self-Focus|Self-Self-Self-Concentration|Self-Self-Self-Meditation|Self-Self-Self-Reflection|Self-Self-Self-Contemplation|Self-Self-Self-Introspection):\s*(.+?)(?:\n|$)/gi;for(;null!==(r=o.exec(e));){let e=r[1].trim(),o=r[2].trim();t[e]=o}return t})(p);if((e=>{for(let r of[/(?:corrected version|here's the corrected version|the corrected version is):\s*(.+?)(?:\n|$)/i,/(?:corrected|fixed):\s*(.+?)(?:\n|$)/i,/(?:should be|it should be):\s*(.+?)(?:\n|$)/i]){let t=e.match(r);if(t)return{mainText:t[1].trim()}}})(p),b(e=>({...e,[r]:m})),T(e=>({...e,[r]:!0})),l(e=>e.map((e,t)=>t===r?{...e,detailedFeedback:p,...f&&{text:f.mainText,romanizedText:f.romanizedText}}:e)),o&&o.id){let e=localStorage.getItem("jwt");try{await s.A.post("/api/messages/feedback",{messageId:o.id,feedback:p},e?{headers:{Authorization:"Bearer ".concat(e)}}:void 0)}catch(e){console.error("Error saving feedback to database:",e)}}}catch(e){console.error("Error getting detailed feedback:",e)}finally{t(e=>({...e,[r]:!1}))}}},[e]),E=(0,n.useCallback)(async(r,o)=>{t(e=>({...e,[r]:!0}));try{let t=await ei(r,o,e);f(e=>({...e,[r]:t})),l(e=>({...e,[r]:!0}))}catch(e){console.error("Error getting short feedback:",e)}finally{t(e=>({...e,[r]:!1}))}},[e]),A=(0,n.useCallback)(async(r,o)=>{t(e=>({...e,[r]:!0}));try{let t=await es(r,o,e);h(e=>({...e,[r]:t})),a(e=>({...e,[r]:!0}))}catch(e){console.error("Error getting detailed breakdown:",e)}finally{t(e=>({...e,[r]:!1}))}},[e]),k=(0,n.useCallback)(async(r,o)=>{t(e=>({...e,[r]:!0}));try{let t=await el(r,o,e);S(e=>({...e,[r]:t})),d(e=>({...e,[r]:!0}))}catch(e){console.error("Error getting quick translation:",e)}finally{t(e=>({...e,[r]:!1}))}},[e]),C=(0,n.useCallback)(async(r,o)=>{t(e=>({...e,[r]:!0}));try{let t=await ec(r,o,e);u(e=>({...e,[r]:t})),a(e=>({...e,[r]:!0}))}catch(e){console.error("Error explaining LLM response:",e)}finally{t(e=>({...e,[r]:!1}))}},[e]);return{isLoadingMessageFeedback:r,showDetailedBreakdown:o,showShortFeedback:i,showQuickTranslations:c,detailedFeedback:g,shortFeedback:p,detailedBreakdown:m,quickTranslations:y,feedbackExplanations:x,showCorrectedVersions:v,handleRequestDetailedFeedback:w,handleRequestShortFeedback:E,handleRequestDetailedBreakdown:A,handleQuickTranslation:k,handleExplainLLMResponse:C,handleToggleDetailedFeedback:(0,n.useCallback)(e=>{a(r=>({...r,[e]:!r[e]}))},[]),handleToggleShortFeedback:(0,n.useCallback)(e=>{l(r=>({...r,[e]:!r[e]}))},[]),setShowDetailedBreakdown:a,setShowShortFeedback:l,setShowQuickTranslations:d,setQuickTranslations:S,setFeedbackExplanations:b,setShowCorrectedVersions:T}})(y);(0,n.useEffect)(()=>{c.lang&&c.lang!==y&&S(c.lang)},[c.lang,y]),(0,n.useEffect)(()=>{p&&p.split(",").filter(e=>e.trim())},[p]),(0,n.useEffect)(()=>{u&&t&&!O&&G!==u&&(console.log("[CONVERSATION_LOAD] Loading conversation from URL:",u),console.log("[CONVERSATION_LOAD] Current conversationId:",C),console.log("[CONVERSATION_LOAD] Loaded conversationId:",G),H(u),rU.loadConversation(u))},[u,t,O,G]),(0,n.useEffect)(()=>{!u&&G&&(console.log("[CONVERSATION_LOAD] URL conversation ID cleared, resetting loaded conversation ID"),H(null),rp(!1),rm(null))},[u,G]),(0,n.useEffect)(()=>{let e=e=>{let r=e.target;!(r&&r.closest('[data-popup="true"]'))&&(r&&r.closest('[data-clickable-word="true"]')||rA(null))};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[]),(0,n.useEffect)(()=>{if(f&&t&&!u){ef(!0);let e=localStorage.getItem("selectedPersona");if(e)try{let r=JSON.parse(e);console.log("[PERSONA] Loading persona data:",r)}catch(e){console.error("[PERSONA] Error parsing persona data:",e)}}},[f,t,u]),(0,n.useEffect)(()=>{u&&!f&&t&&console.log("[PERSONA] Existing conversation without persona flag - will show persona modal")},[u,f,t]),(0,n.useEffect)(()=>{null===t&&e.push("/login")},[t,e]),(0,n.useEffect)(()=>(eQ||e0?document.body.style.overflow="hidden":document.body.style.overflow="unset",()=>{document.body.style.overflow="unset"}),[eQ,e0]),(0,n.useEffect)(()=>{rO.current&&(rO.current.lang=y)},[y]),(0,n.useEffect)(()=>{var e;null==(e=rP.current)||e.scrollIntoView({behavior:"smooth"})},[rF]),(0,n.useEffect)(()=>{let e=setTimeout(()=>{console.log("[TOPIC_MODAL] Checking conditions:",{urlConversationId:u,user:!!t,isLoadingConversation:O,conversationId:C,chatHistoryLength:rF.length,urlParamsConversationId:c.conversationId}),u||!t||O||C||0!==rF.length?u?(console.log("[TOPIC_MODAL] Hiding topic modal - existing conversation from URL"),eZ(!1)):C&&rF.length>0&&(console.log("[TOPIC_MODAL] Hiding topic modal - conversation loaded with messages"),eZ(!1)):(console.log("[TOPIC_MODAL] Showing topic modal - new conversation"),eZ(!0))},200);return()=>clearTimeout(e)},[u,C,t,rF.length,O]),(0,n.useEffect)(()=>{if(t&&1){let e=localStorage.getItem("chatHistory");if(e)try{JSON.parse(e).length>0&&console.log("Found saved chat history, consider saving to backend")}catch(e){console.error("Error parsing saved chat history:",e)}}},[t]),(0,n.useEffect)(()=>{(null==t?void 0:t.selectedLanguage)&&!y&&S(t.selectedLanguage)},[null==t?void 0:t.selectedLanguage,y]),(0,n.useEffect)(()=>{if(1===rF.length&&t&&!v&&!u&&!ru){let e=rF[0];if("AI"===e.sender)if(rp(!0),e.ttsUrl)console.log("\uD83D\uDD0D [INITIAL_TTS] Playing TTS for initial AI message in new conversation:",e.ttsUrl),rM.handlePlayExistingTTS(e.ttsUrl).catch(e=>{console.error("\uD83D\uDD0D [INITIAL_TTS] Error playing existing TTS:",e)});else{console.log("\uD83D\uDD0D [INITIAL_TTS] Generating TTS for initial AI message in new conversation");let r=e.romanizedText||e.text;rM.handlePlayTTS(r,y).catch(e=>{console.error("\uD83D\uDD0D [INITIAL_TTS] Error playing initial AI TTS:",e)})}}},[rF,t,v,y,rM,u,ru]),(0,n.useEffect)(()=>{if(rF.length>0&&t&&!v){let e=rF[rF.length-1],r="".concat(e.timestamp.getTime(),"_").concat(e.text.substring(0,50));if("AI"===e.sender&&!e.isFromOriginalConversation&&rf!==r)if(w)console.log("\uD83D\uDD0D [AUTO_TTS] New AI message detected, but autospeak mode - TTS handled by queue"),rm(r);else if(console.log("\uD83D\uDD0D [AUTO_TTS] New AI message detected, playing TTS (manual mode)"),rm(r),e.ttsUrl)rM.handlePlayExistingTTS(e.ttsUrl).catch(e=>{console.error("\uD83D\uDD0D [AUTO_TTS] Error playing existing TTS:",e)});else{let r=e.romanizedText||e.text;rM.handlePlayTTS(r,y).catch(e=>{console.error("\uD83D\uDD0D [AUTO_TTS] Error playing new AI TTS:",e)})}}},[rF,t,v,y,rM,rf]),(0,n.useEffect)(()=>{!rl&&eA&&!rd&&w&&(console.log("[DEBUG] Short feedback TTS finished, playing AI TTS"),rg(!0),(async()=>{try{await rM.handlePlayTTS(eA.text,eA.language),console.log("[DEBUG] AI TTS finished")}catch(e){console.error("[DEBUG] Error playing AI TTS:",e)}finally{rg(!1),ek(null),w&&(console.log("[DEBUG] AI TTS finished, restarting recording"),setTimeout(()=>{w&&!ew&&(console.log("[DEBUG] Starting recording after AI TTS completion"),rM.handleStartRecording())},300))}})())},[rl,eA,rd,w,ew,rM]),(0,n.useEffect)(()=>{!rd&&eC&&!rl&&w&&(console.log("[DEBUG] AI response TTS finished, playing short feedback TTS"),rc(!0),eE(!0),(async()=>{try{await rM.handlePlayTTS(eC.text,eC.language),console.log("[DEBUG] Short feedback TTS finished")}catch(e){console.error("[DEBUG] Error playing short feedback TTS:",e)}finally{rc(!1),eE(!1),eI(null),w&&(console.log("[DEBUG] Short feedback TTS finished, restarting recording"),setTimeout(()=>{w&&!ew&&(console.log("[DEBUG] Starting recording after short feedback TTS completion"),rM.handleStartRecording())},300))}})())},[rd,eC,rl,w,ew,rM]);let rG=async(e,r,t)=>{e_(r=>({...r,[e]:!0}));try{let t=await $(),o=await s.A.post("/api/translate",{text:r,fromLanguage:y,toLanguage:"en"},{headers:t});o.data.success&&(eO(r=>({...r,[e]:{translation:o.data.translation}})),eR(r=>({...r,[e]:!0})))}catch(e){console.error("Error translating message:",e)}finally{e_(r=>({...r,[e]:!1}))}},rW=async e=>{let r=rF[e];r&&await rL.handleRequestDetailedFeedback(e,r.text,rF,rk,C,rB,e=>Q(e,null==t?void 0:t.id),rC)},rH=async e=>{let r=rF[e];r&&await rL.handleRequestShortFeedback(e,r.text)},rV=async e=>{let r=rF[e];r&&await rL.handleRequestDetailedBreakdown(e,r.text)},rq=async(e,r)=>{if(console.log("[DEBUG] handleQuickTranslation() called with messageIndex:",e,"text:",r),rL.isLoadingMessageFeedback[e])return void console.log("[DEBUG] Already loading, returning early");try{let o=localStorage.getItem("jwt"),n={ai_message:r,chat_history:rF,language:y,user_level:(null==rk?void 0:rk.userLevel)||"beginner",user_topics:(null==rk?void 0:rk.topics)||[],formality:(null==rk?void 0:rk.formality)||"friendly",feedback_language:(null==rk?void 0:rk.feedbackLanguage)||"en",user_goals:(null==t?void 0:t.learning_goals)?"string"==typeof t.learning_goals?JSON.parse(t.learning_goals):t.learning_goals:[],description:R};console.log("[DEBUG] Current userPreferences:",rk);let a=(await s.A.post("/api/quick_translation",n,{headers:{"Content-Type":"application/json",...o?{Authorization:"Bearer ".concat(o)}:{}}})).data;console.log("[DEBUG] handleQuickTranslation() received response:",a);let i=a.translation;console.log("[DEBUG] Raw Gemini translation text:",i);let l=(e=>{let r={fullTranslation:"",wordTranslations:{},romanized:"",error:!1,generatedWords:[],generatedScriptWords:[]};if(!e)return r;console.log("=== PARSING QUICK TRANSLATION ==="),console.log("Raw text:",e),console.log("Text length:",e.length);try{let t=e.split("\n");for(let e of(console.log("Total lines:",t.length),t)){let t=e.trim();if(console.log("Processing line:",'"'.concat(t,'"')),t.includes("**Full Translation:**")){console.log("Found Full Translation section");continue}if(t.includes("**Word-by-Word Breakdown:**")){console.log("Found Word-by-Word Breakdown section");continue}if(t.includes("**Romanized Version:**")){console.log("Found Romanized Version section");continue}if(t.includes(" / ")&&t.includes(" -- ")){console.log("Found script/romanized format:",t);let e=t.split(" -- ");if(2===e.length){let t=e[0].trim(),o=e[1].trim(),n=t.split(" / ");if(2===n.length){let e=n[0].trim(),t=n[1].trim();r.wordTranslations[e]=o,r.wordTranslations[t]=o,r.generatedScriptWords.push(e),r.generatedWords.push(t),console.log('✅ Parsed: script="'.concat(e,'", romanized="').concat(t,'", translation="').concat(o,'"'))}}}else if(t.includes(" -- ")&&!t.includes(" / ")){console.log("Found simple word format:",t);let e=t.split(" -- ");if(2===e.length){let t=e[0].trim(),o=e[1].trim();r.wordTranslations[t]=o,r.generatedWords.push(t),r.generatedScriptWords.push(t),console.log('✅ Parsed: word="'.concat(t,'", translation="').concat(o,'"'))}}else!t||t.startsWith("**")||r.fullTranslation||(console.log("Found full translation:",t),r.fullTranslation=t)}console.log("=== FINAL PARSED RESULT ==="),console.log("Full translation:",r.fullTranslation),console.log("Word translations count:",Object.keys(r.wordTranslations).length),console.log("All word translations:",r.wordTranslations),console.log("Generated script words in order:",r.generatedScriptWords),console.log("Generated romanized words in order:",r.generatedWords)}catch(e){console.error("Error parsing quick translation:",e),r.error=!0}return r})(i);console.log("[DEBUG] Parsed translation:",l),i&&0!==Object.keys(l.wordTranslations).length?(console.log("[DEBUG] Translation received successfully, setting parsed translation"),rL.setQuickTranslations(r=>({...r,[e]:l}))):(console.log("[DEBUG] No translation received, setting error state"),rL.setQuickTranslations(r=>({...r,[e]:{fullTranslation:"Translation failed - please try again",wordTranslations:{},romanized:"",error:!0,generatedWords:[],generatedScriptWords:[]}})))}catch(r){console.error("Quick translation error:",r),rL.setQuickTranslations(r=>({...r,[e]:{fullTranslation:"Translation failed",wordTranslations:{},romanized:"",error:!0,generatedWords:[],generatedScriptWords:[]}}))}},rK=async(e,r)=>{if(console.log("[DEBUG] explainLLMResponse() called with messageIndex:",e,"text:",r),eX)return void console.log("[DEBUG] Already loading, returning early");e$(!0);try{let e=localStorage.getItem("jwt"),o={llm_response:r,user_input:"",context:"",language:y,user_level:(null==rk?void 0:rk.userLevel)||"beginner",user_topics:(null==rk?void 0:rk.topics)||[],formality:(null==rk?void 0:rk.formality)||"friendly",feedback_language:(null==rk?void 0:rk.feedbackLanguage)||"en",user_goals:(null==t?void 0:t.learning_goals)?"string"==typeof t.learning_goals?JSON.parse(t.learning_goals):t.learning_goals:[],description:R},n=(await s.A.post("/api/detailed_breakdown",o,{headers:{"Content-Type":"application/json",...e?{Authorization:"Bearer ".concat(e)}:{}}})).data;console.log("[DEBUG] explainLLMResponse() received response:",n);let a=n.breakdown;if(console.log("[DEBUG] Raw breakdown text:",a),!a)return void console.log("[DEBUG] No breakdown received");eK(a),eJ(!0),eV(!1)}catch(e){console.error("Explain LLM response error:",e)}finally{e$(!1)}},rY=async(e,r,t)=>{await M(e,r,t,e=>{e7(r=>({...r,[t]:e}))})},rJ=async(e,r,t)=>rY(e,r,t||"manual_tts_".concat(Date.now())),rX=async()=>{console.log("\uD83C\uDFC1 [END_CHAT] End chat initiated"),console.log("\uD83C\uDFC1 [END_CHAT] isNewPersona:",em),console.log("\uD83C\uDFC1 [END_CHAT] isUsingPersona:",ep),console.log("\uD83C\uDFC1 [END_CHAT] usePersona (URL param):",f),console.log("\uD83C\uDFC1 [END_CHAT] conversationDescription:",R),console.log("\uD83C\uDFC1 [END_CHAT] conversationId:",C);let r=rF.filter(e=>"User"===e.sender);console.log("\uD83C\uDFC1 [END_CHAT] Chat history:",rF.length),console.log("\uD83C\uDFC1 [END_CHAT] User messages:",r.length),console.log("\uD83C\uDFC1 [END_CHAT] Conversation ID:",C);let t=!C;if(0===r.length&&!t){console.log("\uD83C\uDFC1 [END_CHAT] No user messages in existing conversation, navigating to dashboard without evaluation"),e.push("/dashboard");return}if(console.log("\uD83C\uDFC1 [END_CHAT] Persona modal decision logic:",{isUsingPersona:ep,isUsingPersonaType:typeof ep,usePersona:f,conversationId:C,urlConversationId:u,conversationDescription:R}),ep){console.log("\uD83C\uDFC1 [END_CHAT] Skipping persona modal - using existing persona");try{rF.length>0||t?(console.log("\uD83C\uDFC1 [END_CHAT] Calling generateSummary..."),await rU.generateSummary(rF,(null==rk?void 0:rk.topics)||[],(null==rk?void 0:rk.formality)||"friendly",C||"")||(console.log("\uD83C\uDFC1 [END_CHAT] No progress modal shown, navigating to dashboard"),e.push("/dashboard"))):(console.log("\uD83C\uDFC1 [END_CHAT] No chat history in existing conversation, navigating to dashboard"),e.push("/dashboard"))}catch(r){console.error("\uD83C\uDFC1 [END_CHAT] Error generating conversation summary:",r),e.push("/dashboard")}}else console.log("\uD83C\uDFC1 [END_CHAT] Showing persona modal - no existing persona being used"),e1(!0)},r$=async r=>{B(!0);try{let o={name:r,description:R||"",topics:(null==rk?void 0:rk.topics)||[],formality:(null==rk?void 0:rk.formality)||"neutral",language:y,conversationId:C,userId:null==t?void 0:t.id},n=await s.A.post("/api/personas",o,{headers:await $()});if(201===n.status){if(C)try{await s.A.patch("/api/conversations/".concat(C),{uses_persona:!0,persona_id:n.data.persona.id},{headers:await $()})}catch(e){console.error("Error updating conversation with persona info:",e)}e1(!1);try{let r=rF.filter(e=>"User"===e.sender);console.log("Session messages in savePersona:",rF.length),console.log("User session messages in savePersona:",r.length),console.log("Conversation ID in savePersona:",C);let t=!C;if(0===r.length&&!t){console.log("No user messages in existing conversation, navigating to dashboard without evaluation"),e.push("/dashboard");return}(rF.length>0||t)&&await rU.generateSummary(rF,(null==rk?void 0:rk.topics)||[],(null==rk?void 0:rk.formality)||"friendly",C||"")||e.push("/dashboard")}catch(r){console.error("Error generating conversation summary:",r),e.push("/dashboard")}}}catch(e){console.error("Error saving persona:",e)}finally{B(!1)}};return((0,n.useEffect)(()=>{rM.MediaRecorderClassRef.current=window.MediaRecorder,rM.SpeechRecognitionClassRef.current=window.SpeechRecognition||window.webkitSpeechRecognition,rM.MediaRecorderClassRef.current||console.warn("MediaRecorder API not supported in this browser."),rM.SpeechRecognitionClassRef.current||console.warn("SpeechRecognition API not supported in this browser."),"https:"!==window.location.protocol&&console.warn("getUserMedia requires HTTPS in production. Audio recording may not work.")},[rM.MediaRecorderClassRef,rM.SpeechRecognitionClassRef]),O)?(0,o.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,o.jsx)("div",{className:"text-lg",children:"Loading conversation..."})}):!u||C||O||0!==rF.length?(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(W,{isDarkMode:r,panelWidths:eU,showShortFeedbackPanel:eP,setShowShortFeedbackPanel:eF,ttsDebugInfo:rn,setTtsDebugInfo:ra,romanizationDebugInfo:ri,setRomanizationDebugInfo:rs,translations:eN,showTranslations:eD,feedbackExplanations:rL.feedbackExplanations,showDetailedBreakdown:rb,setShowDetailedBreakdown:rv,parsedBreakdown:rT,activePopup:rE,shortFeedback:eM,quickTranslations:rL.quickTranslations,showQuickTranslation:eH,setShowQuickTranslation:eV,llmBreakdown:eq,showLlmBreakdown:eY,setShowLlmBreakdown:eJ,chatHistory:rF,isLoadingMessageFeedback:rL.isLoadingMessageFeedback,isLoadingExplain:eX,explainLLMResponse:rK,handleRequestDetailedBreakdown:rV,renderClickableMessage:(e,t,n)=>((e,r,t,n,a,i,s)=>{let l="string"==typeof e?e:e.text;if(!t||!t.wordTranslations)return l;if(console.log("renderClickableMessage:",{messageIndex:r,messageText:l,generatedWords:t.generatedWords,generatedScriptWords:t.generatedScriptWords,wordTranslations:t.wordTranslations,availableKeys:Object.keys(t.wordTranslations)}),t.generatedWords&&t.generatedWords.length>0){let e=l.split(/\s+/).filter(e=>e.trim()),o=t.generatedWords;console.log("=== WORD MATCHING DEBUG ==="),console.log("Message words:",e),console.log("Generated words:",o),console.log("Words match:",JSON.stringify(e)===JSON.stringify(o)),JSON.stringify(e)!==JSON.stringify(o)&&(console.warn("⚠️ MISMATCH: Generated words do not match message text!"),console.warn("This suggests cached translation data from a different message."),console.warn("Message index:",r),console.warn("Message text:",l),console.warn("Generated words:",o))}if(t.generatedWords&&t.generatedWords.length>0){let s=l.split(/\s+/).filter(e=>e.trim()),c=t.generatedWords;return JSON.stringify(s)!==JSON.stringify(c)?(console.warn("⚠️ Generated words mismatch detected, falling back to message text parsing"),eg(eu(e,(null==i?void 0:i.romanizationDisplay)||"both"),t,r,n)):t.generatedScriptWords&&t.generatedScriptWords.length>0&&t.generatedScriptWords.some(e=>/[\u0900-\u097F\u0B80-\u0BFF\u0C00-\u0C7F\u0C80-\u0CFF\u0D00-\u0D7F\u0D80-\u0DFF\u0E00-\u0E7F\u0E80-\u0EFF\u0F00-\u0FFF\u1000-\u109F\u1100-\u11FF\u1200-\u137F\u1380-\u139F\u13A0-\u13FF\u1400-\u167F\u1680-\u169F\u16A0-\u16FF\u1700-\u171F\u1720-\u173F\u1740-\u175F\u1760-\u177F\u1780-\u17FF\u1800-\u18AF\u1900-\u194F\u1950-\u197F\u1980-\u19DF\u19E0-\u19FF\u1A00-\u1A1F\u1A20-\u1AAF\u1AB0-\u1AFF\u1B00-\u1B7F\u1B80-\u1BBF\u1BC0-\u1BFF\u1C00-\u1C4F\u1C50-\u1C7F\u1C80-\u1CDF\u1CD0-\u1CFF\u1D00-\u1D7F\u1D80-\u1DBF\u1DC0-\u1DFF\u1E00-\u1EFF\u1F00-\u1FFF]/.test(e))&&t.generatedScriptWords.length>0?(0,o.jsxs)("div",{children:[(0,o.jsxs)("div",{style:{marginBottom:"0.5rem"},children:[(0,o.jsx)("strong",{children:"Script:"}),(0,o.jsx)("div",{style:{marginTop:"0.25rem",fontSize:"1rem",lineHeight:"1.8",wordWrap:"break-word",overflowWrap:"break-word",display:"flex",flexWrap:"wrap",gap:"0.25rem"},children:ed(t.generatedScriptWords,t,r,n)})]}),(0,o.jsxs)("div",{children:[(0,o.jsx)("strong",{children:"Romanized:"}),(0,o.jsx)("div",{style:{marginTop:"0.25rem",fontSize:"0.85rem",lineHeight:"1.6",wordWrap:"break-word",overflowWrap:"break-word",color:a?"#cbd5e1":"#6c757d",display:"flex",flexWrap:"wrap",gap:"0.25rem"},children:ed(t.generatedWords,t,r,n)})]})]}):(0,o.jsx)("div",{children:(0,o.jsx)("div",{style:{marginBottom:"0.5rem"},children:(0,o.jsx)("div",{style:{marginTop:"0.25rem",fontSize:"0.85rem",lineHeight:"1.6",wordWrap:"break-word",overflowWrap:"break-word",display:"flex",flexWrap:"wrap",gap:"0.25rem"},children:ed(t.generatedWords,t,r,n)})})})}return eg(eu(e,(null==i?void 0:i.romanizationDisplay)||"both"),t,r,n)})(e,t,n,rA,r,rk,0),language:y,userPreferences:rk,children:(0,o.jsx)(V,{isDarkMode:r,isRecording:rM.isRecording,onStartRecording:rM.handleStartRecording,onStopRecording:rM.handleStopRecording,autoSpeak:w,setAutoSpeak:E,enableShortFeedback:A,setEnableShortFeedback:k,onEndChat:rX,children:(0,o.jsx)(Y,{chatHistory:rF,isDarkMode:r,onMessageClick:(e,r)=>{},onTranslateMessage:rG,onRequestDetailedFeedback:rW,onRequestShortFeedback:rH,onRequestDetailedBreakdown:rV,onToggleDetailedFeedback:e=>{rL.handleToggleDetailedFeedback(e)},onToggleShortFeedback:e=>{rL.handleToggleShortFeedback(e)},onQuickTranslation:rq,onExplainLLMResponse:async(e,r)=>{await rK(e,r)},onPlayTTS:rJ,onPlayExistingTTS:rM.handlePlayExistingTTS,translations:eN,isTranslating:ej,showTranslations:eD,showDetailedBreakdown:rL.showDetailedBreakdown,showSuggestionExplanations:{},explainButtonPressed:rz.explainButtonPressed,parsedBreakdown:rT,feedbackExplanations:rL.feedbackExplanations,activePopup:rE,showCorrectedVersions:rL.showCorrectedVersions,quickTranslations:rL.quickTranslations,showQuickTranslations:rL.showQuickTranslations,ttsCache:rt,isGeneratingTTS:e6,isPlayingTTS:e9,romanizationDisplay:(null==rk?void 0:rk.romanizationDisplay)||"both",language:y,messageCount:rI,hasMoreMessages:rR,isLoadingMoreMessages:r_,loadMoreMessages:()=>{},userPreferences:rk,handleSuggestionButtonClick:rz.handleSuggestionButtonClick,isLoadingSuggestions:rz.isLoadingSuggestions,isLoadingMessageFeedback:rL.isLoadingMessageFeedback,isLoadingExplain:eX,showSuggestionCarousel:rz.showSuggestionCarousel,suggestionMessages:rz.suggestionMessages,currentSuggestionIndex:rz.currentSuggestionIndex,onNavigateSuggestion:rz.navigateSuggestion,onExplainSuggestion:rz.explainSuggestion,onPlaySuggestionTTS:rz.playSuggestionTTS,isTranslatingSuggestion:rz.isTranslatingSuggestion,showSuggestionTranslations:rz.showSuggestionTranslations,suggestionTranslations:rz.suggestionTranslations})})}),eQ&&(0,o.jsx)(m,{isOpen:eQ,onClose:()=>eZ(!1),onStartConversation:rU.handleModalConversationStart,currentLanguage:y}),e0&&(0,o.jsx)(h,{isOpen:e0,onClose:async()=>{e1(!1);try{let r=rF.filter(e=>"User"===e.sender),t=!C;if(0===r.length&&!t){console.log("\uD83C\uDFC1 [SKIP_PERSONA] No user messages in existing conversation, navigating to dashboard without evaluation"),e.push("/dashboard");return}rF.length>0||t?(console.log("\uD83C\uDFC1 [SKIP_PERSONA] Calling generateSummary..."),await rU.generateSummary(rF,(null==rk?void 0:rk.topics)||[],(null==rk?void 0:rk.formality)||"friendly",C||"")||(console.log("\uD83C\uDFC1 [SKIP_PERSONA] No progress modal shown, navigating to dashboard"),e.push("/dashboard"))):(console.log("\uD83C\uDFC1 [SKIP_PERSONA] No chat history in existing conversation, navigating to dashboard"),e.push("/dashboard"))}catch(r){console.error("\uD83C\uDFC1 [SKIP_PERSONA] Error generating conversation summary:",r),e.push("/dashboard")}},onSave:r$,isSaving:F,currentTopics:(null==rk?void 0:rk.topics)||[],currentDescription:R,currentFormality:(null==rk?void 0:rk.formality)||"neutral"}),(0,o.jsx)(J,{isOpen:e5,onClose:()=>{e2(!1),e8(null),e.push("/dashboard")},progressData:e3}),(0,o.jsx)(X,{activePopup:rE,isDarkMode:r,quickTranslations:rL.quickTranslations,feedbackExplanations:rL.feedbackExplanations})]}):(0,o.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,o.jsxs)("div",{className:"text-center",children:[(0,o.jsx)("div",{className:"text-lg text-red-600 mb-4",children:"❌ Conversation Not Found"}),(0,o.jsxs)("div",{className:"text-gray-600 mb-4",children:["The conversation with ID ",u," could not be loaded."]}),(0,o.jsx)("button",{onClick:()=>e.push("/dashboard"),className:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",children:"Go to Dashboard"})]})})},em=()=>{let[e,r]=(0,n.useState)(!1);return((0,n.useEffect)(()=>{r(!0)},[]),e)?(0,o.jsx)(ef,{}):(0,o.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,o.jsx)("div",{className:"text-lg",children:"Loading analyze page..."})})}}}]);